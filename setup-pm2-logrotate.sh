#!/bin/bash

# PM2 æ—¥å¿—è½®è½¬å’Œç»´æŠ¤è„šæœ¬
# å®‰è£…å’Œé…ç½® pm2-logrotate

set -e

echo "ğŸ”§ é…ç½® PM2 æ—¥å¿—ç®¡ç†..."

# ==========================================
# 1. å®‰è£… pm2-logrotate æ¨¡å—
# ==========================================
echo "ğŸ“¦ å®‰è£… pm2-logrotate..."
npm install -g pm2-logrotate || sudo npm install -g pm2-logrotate

# ==========================================
# 2. é…ç½® pm2-logrotate
# ==========================================
echo "âš™ï¸  é…ç½®æ—¥å¿—è½®è½¬ç­–ç•¥..."

pm2 install pm2-logrotate

# é…ç½®æ—¥å¿—è½®è½¬å‚æ•°
pm2 set pm2-logrotate:max_size 100M          # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§ 100MB
pm2 set pm2-logrotate:retain 20               # ä¿ç•™æœ€è¿‘ 20 ä¸ªæ—¥å¿—æ–‡ä»¶
pm2 set pm2-logrotate:compress true           # å¯ç”¨ gzip å‹ç¼©
pm2 set pm2-logrotate:dateFormat YYYY-MM-DD   # æ—¥æœŸæ ¼å¼
pm2 set pm2-logrotate:rotateModule true       # è½®è½¬ PM2 è‡ªèº«æ—¥å¿—
pm2 set pm2-logrotate:workerInterval 30       # æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡
pm2 set pm2-logrotate:rotateInterval 0 0 * * * # æ¯å¤©åˆå¤œè½®è½¬

echo "âœ… æ—¥å¿—è½®è½¬é…ç½®å®Œæˆï¼"
echo ""
echo "ğŸ“Š å½“å‰é…ç½®ï¼š"
pm2 show pm2-logrotate || echo "pm2-logrotate å·²å®‰è£…"

# ==========================================
# 3. åˆ›å»ºæ—¥å¿—ç›®å½•
# ==========================================
echo ""
echo "ğŸ“ åˆ›å»ºæ—¥å¿—ç›®å½•..."
mkdir -p logs
chmod 755 logs

echo "âœ… æ—¥å¿—ç›®å½•åˆ›å»ºå®Œæˆ"

# ==========================================
# 4. æ˜¾ç¤º PM2 ç›‘æ§çŠ¶æ€
# ==========================================
echo ""
echo "ğŸ¯ PM2 è¿›ç¨‹ç›‘æ§çŠ¶æ€ï¼š"
pm2 list

# ==========================================
# 5. é…ç½®å®Œæˆæç¤º
# ==========================================
echo ""
echo "========================================="
echo "âœ¨ PM2 æ—¥å¿—ç®¡ç†é…ç½®å®Œæˆï¼"
echo "========================================="
echo ""
echo "ğŸ“ å¸¸ç”¨å‘½ä»¤ï¼š"
echo "  - pm2 logs              # æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—"
echo "  - pm2 logs [id]         # æŸ¥çœ‹ç‰¹å®šè¿›ç¨‹æ—¥å¿—"
echo "  - pm2 flush             # æ¸…ç©ºæ‰€æœ‰æ—¥å¿—"
echo "  - pm2 logrotate rotate  # æ‰‹åŠ¨è½®è½¬æ—¥å¿—"
echo ""
echo "âš™ï¸  æ—¥å¿—é…ç½®ï¼š"
echo "  - æœ€å¤§æ–‡ä»¶å¤§å°: 100MB"
echo "  - ä¿ç•™æ–‡ä»¶æ•°: 20"
echo "  - å‹ç¼©: å¯ç”¨"
echo "  - è½®è½¬é¢‘ç‡: æ¯å¤©"
echo ""
