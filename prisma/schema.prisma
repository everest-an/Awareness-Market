// Prisma Schema for Awareness Network
// Database: PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Core Tables (Existing - from Drizzle)
// ============================================================================

model User {
  id                   Int       @id @default(autoincrement())
  openId               String?   @unique @db.VarChar(64)
  name                 String?
  email                String?   @db.VarChar(320)
  password             String?   @db.VarChar(255)
  emailVerified        Boolean   @default(false) @map("email_verified")
  loginMethod          String?   @db.VarChar(64) @map("loginMethod")
  role                 UserRole  @default(consumer)
  userType             UserType? @map("user_type")
  onboardingCompleted  Boolean   @default(false) @map("onboarding_completed")
  bio                  String?
  avatar               String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  lastSignedIn         DateTime? @map("lastSignedIn")

  // Wallet & Credits (for Phantom Auth and Hive Mind)
  walletAddress        String?   @unique @map("wallet_address") @db.VarChar(42)
  creditsBalance       Decimal   @default(0) @map("credits_balance") @db.Decimal(18, 4)
  totalMemories        Int       @default(0) @map("total_memories")
  totalResonances      Int       @default(0) @map("total_resonances")

  // Relations
  createdWorkflows      Workflow[]
  createdVectors        LatentVector[]
  transactions          Transaction[]
  accessPermissions     AccessPermission[]
  reviews               Review[]
  subscriptions         UserSubscription[]
  notifications         Notification[]
  apiKeys               ApiKey[]
  mcpTokens             McpToken[]
  memoryUsageAsConsumer MemoryUsageLog[] @relation("MemoryConsumer")
  memoryUsageAsProvider MemoryUsageLog[] @relation("MemoryProvider")
  verificationCodes     VerificationCode[]

  @@map("users")
}

enum UserRole {
  user
  admin
  creator
  consumer
}

enum UserType {
  creator
  consumer
  both
}

// ============================================================================
// NEW: Agent Collaboration Workflows
// ============================================================================

model Workflow {
  id                  String            @id @db.VarChar(64)
  task                String            @db.VarChar(500)
  description         String?
  status              WorkflowStatus    @default(pending)
  orchestration       Orchestration
  memorySharing       MemorySharing     @default(enabled) @map("memory_sharing")
  memoryTTL           Int               @default(86400) @map("memory_ttl") // seconds
  maxExecutionTime    Int               @default(600) @map("max_execution_time") // seconds
  recordOnChain       Boolean           @default(true) @map("record_on_chain")

  // Execution tracking
  sharedMemory        Json?             @map("shared_memory")
  startedAt           DateTime?         @map("started_at")
  completedAt         DateTime?         @map("completed_at")
  totalExecutionTime  Int?              @map("total_execution_time") // milliseconds

  // Relations
  createdBy           Int               @map("created_by")
  creator             User              @relation(fields: [createdBy], references: [id])
  steps               WorkflowStep[]
  interactions        OnChainInteraction[]

  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  @@index([createdBy])
  @@index([status])
  @@index([createdAt])
  @@map("workflows")
}

model WorkflowStep {
  id              Int             @id @default(autoincrement())
  workflowId      String          @map("workflow_id") @db.VarChar(64)
  stepIndex       Int             @map("step_index")

  // Agent information
  agentId         String          @map("agent_id") @db.VarChar(255)
  agentName       String?         @map("agent_name") @db.VarChar(255)

  // Execution status
  status          StepStatus      @default(pending)

  // Input/output
  input           Json?
  output          Json?
  error           String?

  // Memory coordination
  memoryKeys      Json?           @map("memory_keys") // Array of memory keys

  // Timing
  startedAt       DateTime?       @map("started_at")
  completedAt     DateTime?       @map("completed_at")
  executionTime   Int?            @map("execution_time") // milliseconds

  // Relations
  workflow        Workflow        @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  createdAt       DateTime        @default(now()) @map("created_at")

  @@unique([workflowId, stepIndex])
  @@index([workflowId, stepIndex])
  @@map("workflow_steps")
}

model OnChainInteraction {
  id              Int             @id @default(autoincrement())

  // Workflow context (optional)
  workflowId      String?         @map("workflow_id") @db.VarChar(64)
  workflow        Workflow?       @relation(fields: [workflowId], references: [id], onDelete: SetNull)

  // Agent interaction
  fromAgentId     String          @map("from_agent_id") @db.VarChar(255)
  toAgentId       String          @map("to_agent_id") @db.VarChar(255)

  // Interaction result
  success         Boolean
  weight          Int             @default(50) // Reputation weight
  interactionType String          @default("collaboration") @map("interaction_type") @db.VarChar(50)

  // Blockchain proof
  txHash          String?         @map("tx_hash") @db.VarChar(66)
  blockNumber     Int?            @map("block_number")

  recordedAt      DateTime        @default(now()) @map("recorded_at")

  @@index([workflowId])
  @@index([fromAgentId])
  @@index([toAgentId])
  @@index([txHash])
  @@map("on_chain_interactions")
}

// ============================================================================
// NEW: W-Matrix Marketplace
// ============================================================================

model WMatrixCompatibility {
  id                  Int                 @id @default(autoincrement())
  wMatrixId           String              @map("w_matrix_id") @db.VarChar(64)
  sourceModel         String              @map("source_model") @db.VarChar(100)
  targetModel         String              @map("target_model") @db.VarChar(100)

  // Semantic versioning
  version             String              @db.VarChar(20)
  versionMajor        Int                 @map("version_major")
  versionMinor        Int                 @map("version_minor")
  versionPatch        Int                 @map("version_patch")

  // Quality metrics
  certification       CertificationLevel
  epsilon             Decimal             @db.Decimal(10, 6)
  cosineSimilarity    Decimal?            @map("cosine_similarity") @db.Decimal(10, 6)
  euclideanDistance   Decimal?            @map("euclidean_distance") @db.Decimal(18, 6)
  testSamples         Int?                @map("test_samples")

  // Availability
  available           Boolean             @default(true)

  // Storage
  downloadUrl         String?             @map("download_url") @db.VarChar(512)
  checksumSHA256      String?             @map("checksum_sha256") @db.VarChar(66)
  sizeBytes           Int?                @map("size_bytes")

  // Metadata
  createdBy           Int?                @map("created_by")
  createdAt           DateTime            @default(now()) @map("created_at")

  @@index([sourceModel, targetModel])
  @@index([certification])
  @@index([versionMajor, versionMinor, versionPatch])
  @@index([wMatrixId])
  @@map("w_matrix_compatibility")
}

model WMatrixListing {
  id                  Int                 @id @default(autoincrement())
  sourceModel         String              @map("source_model") @db.VarChar(100)
  targetModel         String              @map("target_model") @db.VarChar(100)
  title               String              @db.VarChar(255)
  description         String
  creatorId           Int                 @map("creator_id")

  // Dimensions
  sourceDimension     Int                 @map("source_dimension")
  targetDimension     Int                 @map("target_dimension")

  // Pricing
  price               Decimal             @db.Decimal(18, 2)

  // Version and quality
  version             String              @db.VarChar(20)
  standard            WMatrixStandard
  certification       CertificationLevel?
  qualityGrade        String?             @map("quality_grade") @db.VarChar(2)

  // Quality metrics
  epsilon             Decimal             @db.Decimal(10, 6)
  cosineSimilarity    Decimal?            @map("cosine_similarity") @db.Decimal(10, 6)
  euclideanDistance   Decimal?            @map("euclidean_distance") @db.Decimal(18, 6)
  testSamples         Int?                @map("test_samples")

  // Storage
  storageUrl          String              @map("storage_url") @db.VarChar(512)
  checksumSHA256      String?             @map("checksum_sha256") @db.VarChar(66)
  sizeBytes           Int?                @map("size_bytes")

  // Marketplace metadata
  tags                Json?
  status              ListingStatus       @default(active)
  downloads           Int                 @default(0)
  views               Int                 @default(0)
  avgRating           Decimal?            @map("avg_rating") @db.Decimal(3, 2)
  reviewCount         Int                 @default(0) @map("review_count")

  // Training metadata (optional)
  trainingDataSize    Int?                @map("training_data_size")
  trainingEpochs      Int?                @map("training_epochs")
  trainingLoss        Decimal?            @map("training_loss") @db.Decimal(10, 6)

  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  @@index([sourceModel, targetModel])
  @@index([creatorId])
  @@index([status])
  @@index([certification])
  @@map("w_matrix_listings")
}

model WMatrixIntegrity {
  listingId           String              @id @map("listing_id") @db.VarChar(64)
  expectedChecksum    String              @map("expected_checksum") @db.VarChar(66)
  actualChecksum      String?             @map("actual_checksum") @db.VarChar(66)
  sizeBytes           Int?                @map("size_bytes")
  valid               Boolean?
  lastVerifiedAt      DateTime?           @map("last_verified_at")
  verificationCount   Int                 @default(1) @map("verification_count")
  createdAt           DateTime            @default(now()) @map("created_at")

  @@map("w_matrix_integrity")
}

// ============================================================================
// Enums
// ============================================================================

enum WorkflowStatus {
  pending
  running
  completed
  failed
  cancelled
}

enum Orchestration {
  sequential
  parallel
}

enum MemorySharing {
  enabled
  disabled
}

enum StepStatus {
  pending
  running
  completed
  failed
}

enum CertificationLevel {
  bronze
  silver
  gold
  platinum
}

enum WMatrixStandard {
  standard_4096  @map("4096")
  standard_8192  @map("8192")
  standard_16384 @map("16384")
}

enum ListingStatus {
  active
  inactive
  suspended
}

// ============================================================================
// Core Business Tables
// ============================================================================

model LatentVector {
  id                  Int       @id @default(autoincrement())
  creatorId           Int       @map("creator_id")
  title               String    @db.VarChar(255)
  description         String
  category            String    @db.VarChar(100)
  vectorFileKey       String    @map("vector_file_key")
  vectorFileUrl       String    @map("vector_file_url")
  modelArchitecture   String?   @map("model_architecture") @db.VarChar(100)
  vectorDimension     Int?      @map("vector_dimension")
  performanceMetrics  String?   @map("performance_metrics")
  basePrice           Decimal   @map("base_price") @db.Decimal(10, 2)
  pricingModel        String    @default("per-call") @map("pricing_model") @db.VarChar(50)
  status              String    @default("draft") @db.VarChar(20)
  totalCalls          Int       @default(0) @map("total_calls")
  totalRevenue        Decimal   @default(0) @map("total_revenue") @db.Decimal(12, 2)
  averageRating       Decimal?  @default(0) @map("average_rating") @db.Decimal(3, 2)
  reviewCount         Int       @default(0) @map("review_count")
  freeTrialCalls      Int       @default(3) @map("free_trial_calls")
  createdAt           DateTime  @default(now()) @map("createdAt")
  updatedAt           DateTime  @default(now()) @updatedAt @map("updatedAt")

  // Hive Mind / SDK Memory fields
  vectorType          String?   @default("marketplace") @map("vector_type") @db.VarChar(50)
  memoryType          String?   @default("latent_vector") @map("memory_type") @db.VarChar(50)
  embeddingProvider   String?   @map("embedding_provider") @db.VarChar(50)
  embeddingModel      String?   @map("embedding_model") @db.VarChar(100)
  embeddingDimension  Int?      @map("embedding_dimension")
  embeddingData       String?   @map("embedding_data") @db.Text  // JSON array stored as text
  isPublic            Boolean   @default(false) @map("is_public")
  resonanceCount      Int       @default(0) @map("resonance_count")
  lastResonanceAt     DateTime? @map("last_resonance_at")

  // Relations
  creator             User              @relation(fields: [creatorId], references: [id])
  transactions        Transaction[]
  accessPermissions   AccessPermission[]
  reviews             Review[]
  apiCallLogs         ApiCallLog[]

  @@index([creatorId])
  @@index([category])
  @@index([status])
  @@index([isPublic])
  @@map("latent_vectors")
}

model Transaction {
  id                    Int       @id @default(autoincrement())
  buyerId               Int       @map("buyer_id")
  vectorId              Int       @map("vector_id")
  amount                Decimal   @db.Decimal(10, 2)
  platformFee           Decimal   @map("platform_fee") @db.Decimal(10, 2)
  creatorEarnings       Decimal   @map("creator_earnings") @db.Decimal(10, 2)
  stripePaymentIntentId String?   @map("stripe_payment_intent_id") @db.VarChar(255)
  status                String    @default("pending") @db.VarChar(20)
  transactionType       String    @default("one-time") @map("transaction_type") @db.VarChar(20)
  createdAt             DateTime  @default(now()) @map("createdAt")
  updatedAt             DateTime  @default(now()) @updatedAt @map("updatedAt")

  // Relations
  buyer                 User              @relation(fields: [buyerId], references: [id])
  vector                LatentVector      @relation(fields: [vectorId], references: [id])
  accessPermissions     AccessPermission[]

  @@index([buyerId])
  @@index([vectorId])
  @@index([status])
  @@map("transactions")
}

model AccessPermission {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")
  vectorId        Int       @map("vector_id")
  transactionId   Int       @map("transaction_id")
  accessToken     String    @unique @map("access_token") @db.VarChar(255)
  expiresAt       DateTime? @map("expires_at")
  callsRemaining  Int?      @map("calls_remaining")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("createdAt")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updatedAt")

  // Relations
  user            User          @relation(fields: [userId], references: [id])
  vector          LatentVector  @relation(fields: [vectorId], references: [id])
  transaction     Transaction   @relation(fields: [transactionId], references: [id])

  @@index([userId, vectorId])
  @@index([accessToken])
  @@map("access_permissions")
}

model Review {
  id                  Int       @id @default(autoincrement())
  vectorId            Int       @map("vector_id")
  userId              Int       @map("user_id")
  rating              Int
  comment             String?
  isVerifiedPurchase  Boolean   @default(false) @map("is_verified_purchase")
  createdAt           DateTime  @default(now()) @map("createdAt")
  updatedAt           DateTime  @default(now()) @updatedAt @map("updatedAt")

  // Relations
  vector              LatentVector  @relation(fields: [vectorId], references: [id])
  user                User          @relation(fields: [userId], references: [id])

  @@index([vectorId])
  @@index([userId])
  @@map("reviews")
}

model SubscriptionPlan {
  id              Int       @id @default(autoincrement())
  name            String    @db.VarChar(100)
  description     String?
  price           Decimal   @db.Decimal(10, 2)
  billingCycle    String    @map("billing_cycle") @db.VarChar(20)
  features        String?
  callLimit       Int?      @map("call_limit")
  stripePriceId   String?   @map("stripe_price_id") @db.VarChar(255)
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("createdAt")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updatedAt")

  // Relations
  subscriptions   UserSubscription[]

  @@map("subscription_plans")
}

model UserSubscription {
  id                  Int       @id @default(autoincrement())
  userId              Int       @map("user_id")
  planId              Int       @map("plan_id")
  stripeSubscriptionId String?  @map("stripe_subscription_id") @db.VarChar(255)
  status              String    @default("active") @db.VarChar(20)
  currentPeriodStart  DateTime  @map("current_period_start")
  currentPeriodEnd    DateTime  @map("current_period_end")
  cancelAtPeriodEnd   Boolean   @default(false) @map("cancel_at_period_end")
  createdAt           DateTime  @default(now()) @map("createdAt")
  updatedAt           DateTime  @default(now()) @updatedAt @map("updatedAt")

  // Relations
  user                User              @relation(fields: [userId], references: [id])
  plan                SubscriptionPlan  @relation(fields: [planId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("user_subscriptions")
}

model ApiKey {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  keyHash     String    @unique @map("key_hash") @db.VarChar(255)
  keyPrefix   String    @map("key_prefix") @db.VarChar(16)
  name        String    @db.VarChar(255)
  permissions String?
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("createdAt")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updatedAt")

  // Relations
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([keyHash])
  @@map("api_keys")
}

model McpToken {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  tokenHash   String    @unique @map("token_hash") @db.VarChar(255)
  tokenPrefix String    @map("token_prefix") @db.VarChar(16)
  name        String    @db.VarChar(255)
  permissions String?
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("createdAt")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updatedAt")

  // Relations
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([tokenHash])
  @@map("mcp_tokens")
}

model ApiCallLog {
  id           Int       @id @default(autoincrement())
  userId       Int       @map("user_id")
  vectorId     Int       @map("vector_id")
  permissionId Int       @map("permission_id")
  responseTime Int?      @map("response_time")
  success      Boolean   @default(true)
  errorMessage String?   @map("error_message")
  createdAt    DateTime  @default(now()) @map("createdAt")

  // Relations
  vector       LatentVector  @relation(fields: [vectorId], references: [id])

  @@index([userId])
  @@index([vectorId])
  @@index([createdAt])
  @@map("api_call_logs")
}

model Notification {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")
  type            String    @db.VarChar(50)
  title           String    @db.VarChar(255)
  message         String
  isRead          Boolean   @default(false) @map("is_read")
  relatedEntityId Int?      @map("related_entity_id")
  createdAt       DateTime  @default(now()) @map("createdAt")

  // Relations
  user            User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model UserPreference {
  id                      Int       @id @default(autoincrement())
  userId                  Int       @unique @map("user_id")
  preferredCategories     String?   @map("preferred_categories")
  priceRange              String?   @map("price_range")
  lastRecommendationUpdate DateTime? @map("last_recommendation_update")
  createdAt               DateTime  @default(now()) @map("createdAt")
  updatedAt               DateTime  @default(now()) @updatedAt @map("updatedAt")

  @@map("user_preferences")
}

model BrowsingHistory {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  vectorId  Int       @map("vector_id")
  action    String    @db.VarChar(20)
  metadata  String?
  createdAt DateTime  @default(now()) @map("createdAt")

  @@index([userId])
  @@index([vectorId])
  @@index([createdAt])
  @@map("browsing_history")
}

model AiMemory {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  memoryKey   String    @map("memory_key") @db.VarChar(255)
  memoryData  String    @map("memory_data")
  version     Int       @default(1)
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("createdAt")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updatedAt")

  @@index([userId, memoryKey])
  @@map("ai_memory")
}

// ============================================================================
// LatentMAS Package System
// ============================================================================

model VectorPackage {
  id                  Int       @id @default(autoincrement())
  packageId           String    @unique @map("package_id") @db.VarChar(64)
  userId              Int       @map("user_id")
  name                String    @db.VarChar(255)
  description         String
  vectorUrl           String    @map("vector_url")
  wMatrixUrl          String    @map("w_matrix_url")
  packageUrl          String    @map("package_url")
  sourceModel         String    @map("source_model") @db.VarChar(50)
  targetModel         String    @map("target_model") @db.VarChar(50)
  dimension           Int
  epsilon             Decimal   @db.Decimal(10, 8)
  informationRetention Decimal  @map("information_retention") @db.Decimal(5, 4)
  qualityScore        Decimal?  @default(0) @map("quality_score") @db.Decimal(5, 4)
  category            String    @default("nlp") @db.VarChar(50)
  price               Decimal   @db.Decimal(10, 2)
  downloads           Int       @default(0)
  rating              Decimal?  @default(0) @db.Decimal(3, 2)
  reviewCount         Int       @default(0) @map("review_count")
  status              String    @default("draft") @db.VarChar(20)
  createdAt           DateTime  @default(now()) @map("createdAt")
  updatedAt           DateTime  @default(now()) @updatedAt @map("updatedAt")

  @@index([userId])
  @@index([category])
  @@index([status])
  @@index([sourceModel, targetModel])
  @@map("vector_packages")
}

model MemoryPackage {
  id                  Int       @id @default(autoincrement())
  packageId           String    @unique @map("package_id") @db.VarChar(64)
  userId              Int       @map("user_id")
  name                String    @db.VarChar(255)
  description         String
  memoryType          String    @default("kv_cache") @map("memory_type") @db.VarChar(50)
  kvCacheUrl          String    @map("kv_cache_url")
  wMatrixUrl          String    @map("w_matrix_url")
  packageUrl          String    @map("package_url")
  sourceModel         String    @map("source_model") @db.VarChar(50)
  targetModel         String    @map("target_model") @db.VarChar(50)
  tokenCount          Int       @map("token_count")
  compressionRatio    Decimal   @map("compression_ratio") @db.Decimal(5, 4)
  contextDescription  String    @map("context_description")
  epsilon             Decimal   @db.Decimal(10, 8)
  informationRetention Decimal  @map("information_retention") @db.Decimal(5, 4)
  price               Decimal   @db.Decimal(10, 2)
  downloads           Int       @default(0)
  rating              Decimal?  @default(0) @db.Decimal(3, 2)
  reviewCount         Int       @default(0) @map("review_count")
  status              String    @default("draft") @db.VarChar(20)
  createdAt           DateTime  @default(now()) @map("createdAt")
  updatedAt           DateTime  @default(now()) @updatedAt @map("updatedAt")

  @@index([userId])
  @@index([status])
  @@index([sourceModel, targetModel])
  @@map("memory_packages")
}

model ChainPackage {
  id                  Int       @id @default(autoincrement())
  packageId           String    @unique @map("package_id") @db.VarChar(64)
  userId              Int       @map("user_id")
  name                String    @db.VarChar(255)
  description         String
  chainUrl            String    @map("chain_url")
  wMatrixUrl          String    @map("w_matrix_url")
  packageUrl          String    @map("package_url")
  sourceModel         String    @map("source_model") @db.VarChar(50)
  targetModel         String    @map("target_model") @db.VarChar(50)
  stepCount           Int       @map("step_count")
  problemType         String    @map("problem_type") @db.VarChar(100)
  solutionQuality     Decimal   @map("solution_quality") @db.Decimal(5, 4)
  epsilon             Decimal   @db.Decimal(10, 8)
  informationRetention Decimal  @map("information_retention") @db.Decimal(5, 4)
  price               Decimal   @db.Decimal(10, 2)
  downloads           Int       @default(0)
  rating              Decimal?  @default(0) @db.Decimal(3, 2)
  reviewCount         Int       @default(0) @map("review_count")
  status              String    @default("draft") @db.VarChar(20)
  createdAt           DateTime  @default(now()) @map("createdAt")
  updatedAt           DateTime  @default(now()) @updatedAt @map("updatedAt")

  @@index([userId])
  @@index([problemType])
  @@index([status])
  @@index([sourceModel, targetModel])
  @@map("chain_packages")
}

model PackagePurchase {
  id                    Int       @id @default(autoincrement())
  packageType           String    @map("package_type") @db.VarChar(20)
  packageId             String    @map("package_id") @db.VarChar(64)
  buyerId               Int       @map("buyer_id")
  sellerId              Int       @map("seller_id")
  price                 Decimal   @db.Decimal(10, 2)
  platformFee           Decimal   @map("platform_fee") @db.Decimal(10, 2)
  sellerEarnings        Decimal   @map("seller_earnings") @db.Decimal(10, 2)
  stripePaymentIntentId String?   @map("stripe_payment_intent_id") @db.VarChar(255)
  status                String    @default("pending") @db.VarChar(20)
  purchasedAt           DateTime  @default(now()) @map("purchasedAt")

  @@index([packageType, packageId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@map("package_purchases")
}

// ============================================================================
// Hive Mind Memory Usage Logging
// ============================================================================

model MemoryUsageLog {
  id              Int       @id @default(autoincrement())
  consumerId      Int       @map("consumer_id")
  providerId      Int       @map("provider_id")
  memoryId        Int       @map("memory_id")
  similarity      Decimal   @db.Decimal(10, 8)
  cost            Decimal   @default(0) @db.Decimal(18, 4)
  contextQuery    String?   @map("context_query")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  consumer        User      @relation("MemoryConsumer", fields: [consumerId], references: [id])
  provider        User      @relation("MemoryProvider", fields: [providerId], references: [id])

  @@index([consumerId])
  @@index([providerId])
  @@index([memoryId])
  @@index([createdAt])
  @@map("memory_usage_log")
}

// ============================================================================
// Memory NFT and Provenance
// ============================================================================

model MemoryNFT {
  id                  String    @id @db.VarChar(255)
  contractAddress     String    @map("contract_address") @db.VarChar(42)
  tokenId             String    @map("token_id") @db.VarChar(78)
  owner               String    @db.VarChar(42)
  tbaAddress          String?   @map("tba_address") @db.VarChar(42)

  // Metadata
  name                String    @db.VarChar(255)
  description         String?
  memoryType          String    @map("memory_type") @db.VarChar(50)

  // Quality metrics
  epsilon             String?   @db.VarChar(20)
  certification       String?   @db.VarChar(20)
  qualityGrade        String?   @map("quality_grade") @db.VarChar(20)

  // Asset references
  assetUrl            String?   @map("asset_url")
  metadataUrl         String?   @map("metadata_url")

  // Provenance
  parentNftId         String?   @map("parent_nft_id") @db.VarChar(255)
  derivationType      String?   @map("derivation_type") @db.VarChar(50)
  royaltyPercent      Int       @default(30) @map("royalty_percent")
  totalRoyaltiesPaid  String    @default("0") @map("total_royalties_paid") @db.VarChar(78)

  // Marketplace
  price               String?   @db.VarChar(78)
  downloads           Int       @default(0)

  // Timestamps
  mintedAt            DateTime  @default(now()) @map("minted_at")
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at")

  @@index([contractAddress, tokenId])
  @@index([owner])
  @@index([tbaAddress])
  @@index([memoryType])
  @@index([parentNftId])
  @@map("memory_nfts")
}

// ============================================================================
// Email Verification System
// ============================================================================

model VerificationCode {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  email     String   @db.VarChar(320)
  code      String   @db.VarChar(6)
  type      String   @default("email_verification") @db.VarChar(50)
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, code, type])
  @@index([expiresAt])
  @@index([userId])
  @@map("verification_codes")
}
