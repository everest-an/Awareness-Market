# Webhook & AI 协作架构文档

> Awareness Market - 多 Agent 协作系统架构

---

## 📐 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              外部系统层                                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  外部 Agent  │  │ GitHub API   │  │  Stripe      │  │  区块链节点   │   │
│  │   服务器     │  │              │  │  Webhook     │  │  (ERC-8004)  │   │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘   │
└─────────┼──────────────────┼──────────────────┼──────────────────┼───────────┘
          │                  │                  │                  │
          │ HTTP Webhook     │ OAuth/API        │ Payment Events   │ Web3 RPC
          │                  │                  │                  │
┌─────────▼──────────────────▼──────────────────▼──────────────────▼───────────┐
│                           API Gateway 层                                      │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  Express.js Router + Rate Limiter + HMAC Verifier              │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│         │                           │                           │             │
│    /api/webhooks/inbound      /api/collaborate         /api/mcp              │
└─────────┼───────────────────────────┼───────────────────────────┼────────────┘
          │                           │                           │
          │                           │                           │
┌─────────▼───────────────────────────▼───────────────────────────▼────────────┐
│                          核心业务逻辑层                                        │
│                                                                               │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────┐  │
│  │  Webhook Adapter     │  │  Agent Collaboration │  │  MCP Cloud Server│  │
│  │  • 签名验证          │  │  Router              │  │  • 10 Tools      │  │
│  │  • Payload 解析      │  │  • 工作流编排        │  │  • Permission    │  │
│  │  • 队列入队          │  │  • 顺序/并行执行     │  │  • Stateless     │  │
│  └──────────┬───────────┘  └──────────┬───────────┘  └──────────┬───────┘  │
│             │                          │                          │           │
└─────────────┼──────────────────────────┼──────────────────────────┼───────────┘
              │                          │                          │
              │                          │                          │
┌─────────────▼──────────────────────────▼──────────────────────────▼───────────┐
│                          消息队列层 (BullMQ + Redis)                          │
│                                                                               │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────┐  │
│  │ Inbound Queue        │  │ Outbound Queue       │  │ Dead Letter Queue│  │
│  │ • 并发: 3            │  │ • 并发: 5            │  │ • 永久失败的任务 │  │
│  │ • 限流: 10 jobs/s    │  │ • 限流: 20 jobs/s    │  │                  │  │
│  │ • 异步处理 webhook   │  │ • 重试: 3次          │  │                  │  │
│  └──────────┬───────────┘  └──────────┬───────────┘  └──────────────────┘  │
└─────────────┼──────────────────────────┼──────────────────────────────────────┘
              │                          │
              │                          │
┌─────────────▼──────────────────────────▼──────────────────────────────────────┐
│                            Worker 处理层                                       │
│                                                                               │
│  ┌────────────────────────────────┐  ┌────────────────────────────────┐     │
│  │  Webhook Inbound Worker        │  │  Webhook Outbound Worker       │     │
│  │                                │  │                                │     │
│  │  • 解析 webhook action         │  │  • 分发事件通知                │     │
│  │  • propose → 存储提议          │  │  • HMAC 签名 payload           │     │
│  │  • execute → 触发工作流        │  │  • 指数退避重试                │     │
│  │  • stop → 取消执行             │  │  • 超时: 10秒                  │     │
│  │  • sync → 调用 MCP sync        │  │  • 审计日志记录                │     │
│  │  • tool → 调用 MCP tool        │  │                                │     │
│  └────────────┬───────────────────┘  └────────────────────────────────┘     │
└─────────────────┼──────────────────────────────────────────────────────────────┘
                  │
                  │
┌─────────────────▼──────────────────────────────────────────────────────────────┐
│                          工作流执行引擎                                        │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  executeWorkflow(workflowId)                                   │        │
│  │                                                                 │        │
│  │  FOR EACH WorkflowStep:                                        │        │
│  │    1. 触发 webhook: workflow.step.started                       │        │
│  │    2. 调用 Agent 端点 (HTTP POST)                               │        │
│  │    3. 存储输出到 sharedMemory                                   │        │
│  │    4. 记录链上交互 (ERC-8004)                                   │        │
│  │    5. 触发 webhook: workflow.step.completed/failed             │        │
│  │                                                                 │        │
│  │  IF orchestration = "parallel":                                │        │
│  │    • 所有 agent 并发执行                                        │        │
│  │    • 权威加权共识决策                                           │        │
│  │                                                                 │        │
│  │  最终: 触发 webhook: workflow.completed/failed                  │        │
│  └─────────────────────────────────────────────────────────────────┘        │
└─────────────────┬──────────────────────────────────────────────────────────────┘
                  │
                  │
┌─────────────────▼──────────────────────────────────────────────────────────────┐
│                          数据持久化层 (PostgreSQL)                            │
│                                                                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │  Workflow       │  │  WorkflowStep   │  │  WebhookEvent   │             │
│  │  • 工作流配置   │  │  • Step 执行    │  │  • 审计日志     │             │
│  │  • sharedMemory │  │  • input/output │  │  • 状态追踪     │             │
│  │  • webhook配置  │  │  • 执行时间     │  │  • 重试记录     │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │  Agent          │  │  MCPToken       │  │  User           │             │
│  │  • AI模型信息   │  │  • 权限管理     │  │  • 认证信息     │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 完整数据流程（时序图）

### 场景 1: 外部系统通过 Webhook 触发工作流执行

```
外部系统          API Gateway      Webhook Adapter    BullMQ Queue    Inbound Worker    Workflow Engine    Agent端点    Outbound Worker    外部回调URL
    │                  │                  │                 │                │                 │              │               │                  │
    ├─POST /webhooks──→│                  │                 │                │                 │              │               │                  │
    │  + HMAC签名      │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  ├─验证签名─────────→│                 │                │                 │              │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  │                  ├─Zod验证─────────→│                │                 │              │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 ├─入队 job────→│                 │              │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │←─200 OK──────────┤                  │                 │                │                 │              │               │                  │
    │  {jobId}         │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 │                ├─处理 job───────→│              │               │                  │
    │                  │                  │                 │                │  action=execute │              │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 │                │                 ├─更新状态────→│              │               │                  │
    │                  │                  │                 │                │                 │ running      │              │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 │                │                 ├─FOR step 0──→│              │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 │                │                 │              ├─HTTP POST────→│               │                  │
    │                  │                  │                 │                │                 │              │  +context    │               │                  │
    │                  │                  │                 │                │                 │              │  +authority  │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 │                │                 │              │←─response────┤               │                  │
    │                  │                  │                 │                │                 │              │  {output}    │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 │                │                 │←─存储output──┤              │               │                  │
    │                  │                  │                 │                │                 │  sharedMemory│              │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 │                │                 ├─record链上───→│              │               │                  │
    │                  │                  │                 │                │                 │  ERC-8004    │              │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 │                │                 ├─emit event───┼──────────────→│               │                  │
    │                  │                  │                 │                │                 │ step.completed              │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 │                │                 │              │               ├─POST webhook────→│
    │                  │                  │                 │                │                 │              │               │  + HMAC签名      │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │←─200 OK───┤
    │                  │                  │                 │                │                 │              │               │                  │           │
    │                  │                  │                 │                │                 ├─完成所有steps─┤              │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 │                │                 ├─emit event───┼──────────────→│               │                  │
    │                  │                  │                 │                │                 │ workflow.completed          │               │                  │
    │                  │                  │                 │                │                 │              │               │                  │
    │                  │                  │                 │                │                 │              │               ├─POST webhook────→│
    │                  │                  │                 │                │                 │              │               │                  │
```

---

## 🏗️ 核心组件详解

### 1️⃣ Webhook 入站处理流程

```
┌────────────────────────────────────────────────────────────────┐
│  server/routes/webhook-inbound.ts                             │
│  职责: 接收外部 webhook 请求                                   │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌──────────────────────────────────────────────────────┐    │
│  │  1. Rate Limiter 检查                                │    │
│  │     • 30 请求/分钟/IP                                 │    │
│  │     • 超限返回 429                                    │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  2. 提取 payload 和 签名                             │    │
│  │     • X-Webhook-Signature header                     │    │
│  │     • workflowId from body                           │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  3. 从数据库获取 Workflow                            │    │
│  │     • SELECT * FROM Workflow WHERE id = ?            │    │
│  │     • 验证 workflow 存在                              │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  4. HMAC-SHA256 签名验证                             │    │
│  │     • 使用 workflow.webhookSecret                    │    │
│  │     • 时间窗口: 5 分钟                                │    │
│  │     • 格式: t=<timestamp>,v1=<hmac_hex>              │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  5. 调用 Webhook Adapter                             │    │
│  │     • processInboundWebhook(payload)                 │    │
│  │     • 返回 jobId                                      │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  6. 返回 202 Accepted                                │    │
│  │     • { success: true, jobId: "xxx" }                │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                                │
└────────────────────────────────────────────────────────────────┘

                            ▼

┌────────────────────────────────────────────────────────────────┐
│  server/collaboration/webhook-adapter.ts                       │
│  职责: 验证、解析、入队                                         │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌──────────────────────────────────────────────────────┐    │
│  │  1. Zod Schema 验证                                  │    │
│  │     • action: propose|execute|stop|sync|tool         │    │
│  │     • workflowId: 必需                                │    │
│  │     • requestId: 幂等键 (可选)                        │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  2. 幂等性检查                                        │    │
│  │     • 检查 requestId 是否已处理                       │    │
│  │     • 重复请求返回原 jobId                            │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  3. 创建审计日志                                      │    │
│  │     • INSERT INTO WebhookEvent                       │    │
│  │     • status: "pending"                              │    │
│  │     • direction: "inbound"                           │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  4. 入队到 BullMQ                                     │    │
│  │     • webhookInboundQueue.add()                      │    │
│  │     • 返回 Job ID                                     │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                                │
└────────────────────────────────────────────────────────────────┘

                            ▼

┌────────────────────────────────────────────────────────────────┐
│  server/workers/webhook-inbound-worker.ts                      │
│  职责: 异步处理 webhook 业务逻辑                               │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌──────────────────────────────────────────────────────┐    │
│  │  Worker 配置                                         │    │
│  │  • concurrency: 3 个并发作业                          │    │
│  │  • rate limiter: 10 作业/秒                           │    │
│  │  • Redis connection                                  │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                                │
│  ┌──────────────────────────────────────────────────────┐    │
│  │  处理逻辑 (switch by action)                          │    │
│  ├──────────────────────────────────────────────────────┤    │
│  │                                                       │    │
│  │  action = "propose":                                 │    │
│  │    • 存储到 workflow.sharedMemory._proposals         │    │
│  │    • emit outbound: workflow.propose                 │    │
│  │                                                       │    │
│  │  action = "execute":                                 │    │
│  │    • 验证 workflow.status === "pending"              │    │
│  │    • 调用 executeWorkflow(workflowId)                │    │
│  │    • 更新状态为 "running"                            │    │
│  │                                                       │    │
│  │  action = "stop":                                    │    │
│  │    • 设置 workflow.status = "cancelled"              │    │
│  │    • emit outbound: workflow.failed                  │    │
│  │                                                       │    │
│  │  action = "sync":                                    │    │
│  │    • POST /api/mcp/sync                              │    │
│  │    • 传递 shared_context 和 agents                   │    │
│  │                                                       │    │
│  │  action = "tool":                                    │    │
│  │    • 验证 toolName 在 VALID_MCP_TOOLS 中             │    │
│  │    • 调用 MCP Cloud Server (JSON-RPC)                │    │
│  │    • 在 workflow 上下文中执行工具                    │    │
│  │                                                       │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                                │
│  ┌──────────────────────────────────────────────────────┐    │
│  │  完成处理                                             │    │
│  │  • 更新 WebhookEvent.status = "delivered"            │    │
│  │  • 记录 processedAt 时间戳                           │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

### 2️⃣ Webhook 出站通知流程

```
┌────────────────────────────────────────────────────────────────┐
│  server/collaboration/webhook-dispatcher.ts                    │
│  职责: 分发工作流事件通知                                       │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  支持的事件类型:                                               │
│  ┌──────────────────────────────────────────────────────┐    │
│  │  • workflow.created          新工作流创建             │    │
│  │  • workflow.propose          收到提议                 │    │
│  │  • workflow.execute          开始执行                 │    │
│  │  • workflow.step.started     步骤开始                 │    │
│  │  • workflow.step.completed   步骤完成                 │    │
│  │  • workflow.step.failed      步骤失败                 │    │
│  │  • workflow.completed        工作流完成               │    │
│  │  • workflow.failed           工作流失败               │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                                │
│  分发流程:                                                     │
│  ┌──────────────────────────────────────────────────────┐    │
│  │  1. 检查 workflow.webhookUrl 是否配置                 │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  2. 检查 event 是否在 workflow.webhookEvents 中       │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  3. 构造 payload                                      │    │
│  │     {                                                 │    │
│  │       event: "workflow.step.completed",              │    │
│  │       workflowId: "wf_xxx",                          │    │
│  │       timestamp: "2026-02-26T...",                   │    │
│  │       data: { ... }                                  │    │
│  │     }                                                 │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  4. 生成 HMAC-SHA256 签名                             │    │
│  │     • 使用 workflow.webhookSecret                    │    │
│  │     • 格式: t=<timestamp>,v1=<hmac>                  │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  5. 入队到 webhookOutboundQueue                       │    │
│  │     • job data: { url, payload, signature, headers } │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                                │
└────────────────────────────────────────────────────────────────┘

                            ▼

┌────────────────────────────────────────────────────────────────┐
│  server/workers/webhook-outbound-worker.ts                     │
│  职责: 可靠地发送 webhook 通知                                 │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  Worker 配置:                                                  │
│  ┌──────────────────────────────────────────────────────┐    │
│  │  • concurrency: 5                                    │    │
│  │  • rate limiter: 20 作业/秒                           │    │
│  │  • max attempts: 3                                   │    │
│  │  • exponential backoff: 10s → 30s → 90s             │    │
│  │  • timeout: 10 秒/请求                                │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                                │
│  处理流程:                                                     │
│  ┌──────────────────────────────────────────────────────┐    │
│  │  1. HTTP POST 到目标 URL                              │    │
│  │     Headers:                                         │    │
│  │     • X-Webhook-Signature                            │    │
│  │     • X-Webhook-Event                                │    │
│  │     • X-Workflow-Id                                  │    │
│  │     • User-Agent: AwarenessMarket-Webhook/1.0        │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  2. 处理响应                                          │    │
│  │     • 2xx: 成功，更新 WebhookEvent.status=delivered  │    │
│  │     • 4xx: 客户端错误，停止重试，status=failed        │    │
│  │     • 5xx: 服务器错误，重试                           │    │
│  │     • Timeout: 重试                                   │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  3. 重试逻辑                                          │    │
│  │     Attempt 1: 立即                                   │    │
│  │     Attempt 2: +10 秒                                 │    │
│  │     Attempt 3: +30 秒                                 │    │
│  │     失败后: → Dead Letter Queue                       │    │
│  └──────────────────┬───────────────────────────────────┘    │
│                     │                                          │
│  ┌──────────────────▼───────────────────────────────────┐    │
│  │  4. 审计日志更新                                      │    │
│  │     • UPDATE WebhookEvent                            │    │
│  │     • SET attempts = attempts + 1                    │    │
│  │     • SET statusCode, error, processedAt             │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

### 3️⃣ AI 协作工作流引擎

```
┌──────────────────────────────────────────────────────────────────────┐
│  server/routers/agent-collaboration.ts                              │
│  核心: 多 Agent 工作流编排                                           │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  API Procedure: collaborate                                         │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  输入参数:                                                  │    │
│  │  {                                                          │    │
│  │    task: string                    // 任务描述              │    │
│  │    description?: string            // 详细说明              │    │
│  │    agents: Array<{                 // Agent 配置            │    │
│  │      agentId: string,                                       │    │
│  │      role: string,                                          │    │
│  │      endpoint?: string,            // 自定义 API 端点       │    │
│  │      authority?: number            // 权威值 (0.0-1.0)     │    │
│  │    }>                                                       │    │
│  │    orchestration: "sequential" | "parallel"                │    │
│  │    memorySharing: boolean          // 启用共享内存          │    │
│  │    memoryTTL?: number              // 内存 TTL (秒)         │    │
│  │    maxExecutionTime?: number       // 最大执行时间 (秒)     │    │
│  │    recordOnChain: boolean          // 链上记录              │    │
│  │    webhookUrl?: string             // Webhook 回调 URL      │    │
│  │    webhookSecret?: string          // Webhook 密钥          │    │
│  │    webhookEvents?: string[]        // 订阅的事件类型        │    │
│  │    mcpToken?: string               // MCP 认证 token        │    │
│  │  }                                                          │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  创建流程:                                                           │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  1. 验证用户权限                                            │    │
│  │     • 检查用户是否登录                                      │    │
│  │     • 验证 agents 是否属于用户或公开                        │    │
│  └──────────────┬─────────────────────────────────────────────┘    │
│                 │                                                    │
│  ┌──────────────▼─────────────────────────────────────────────┐    │
│  │  2. 创建 Workflow 记录                                      │    │
│  │     • 生成 workflowId                                       │    │
│  │     • status: "pending"                                     │    │
│  │     • 初始化 sharedMemory = {}                              │    │
│  │     • 自动生成 webhookSecret (如果需要)                     │    │
│  └──────────────┬─────────────────────────────────────────────┘    │
│                 │                                                    │
│  ┌──────────────▼─────────────────────────────────────────────┐    │
│  │  3. 创建 WorkflowStep 记录                                  │    │
│  │     • 为每个 agent 创建一个 step                            │    │
│  │     • stepIndex: 0, 1, 2, ...                               │    │
│  │     • status: "pending"                                     │    │
│  └──────────────┬─────────────────────────────────────────────┘    │
│                 │                                                    │
│  ┌──────────────▼─────────────────────────────────────────────┐    │
│  │  4. 自动生成 MCP Token (如果未提供)                         │    │
│  │     • INSERT INTO MCPToken                                  │    │
│  │     • permissions: ["read", "write", "propose"]             │    │
│  │     • workflowId: 关联到当前工作流                          │    │
│  │     • expiresAt: 基于 memoryTTL                             │    │
│  └──────────────┬─────────────────────────────────────────────┘    │
│                 │                                                    │
│  ┌──────────────▼─────────────────────────────────────────────┐    │
│  │  5. 触发 webhook: workflow.created                          │    │
│  │     • 如果配置了 webhookUrl                                 │    │
│  └──────────────┬─────────────────────────────────────────────┘    │
│                 │                                                    │
│  ┌──────────────▼─────────────────────────────────────────────┐    │
│  │  6. 返回工作流信息                                          │    │
│  │     {                                                       │    │
│  │       workflowId: "wf_xxx",                                 │    │
│  │       status: "pending",                                    │    │
│  │       mcpToken: "mcp_xxx",                                  │    │
│  │       webhookUrl: "...",                                    │    │
│  │       sessionEndpoints: {                                   │    │
│  │         api: "https://.../api/collaboration/wf_xxx",        │    │
│  │         mcp: "https://.../api/mcp"                          │    │
│  │       }                                                     │    │
│  │     }                                                       │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘

                                ▼

┌──────────────────────────────────────────────────────────────────────┐
│  server/db-workflows.ts: executeWorkflow(workflowId)                │
│  核心执行引擎                                                         │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  执行流程:                                                           │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  1. 加载 Workflow 和 WorkflowSteps                          │    │
│  │     • 验证 status === "pending"                             │    │
│  │     • 加载所有 steps 和 agent 信息                          │    │
│  └──────────────┬─────────────────────────────────────────────┘    │
│                 │                                                    │
│  ┌──────────────▼─────────────────────────────────────────────┐    │
│  │  2. 更新 workflow.status = "running"                        │    │
│  │     • 记录 startedAt 时间戳                                 │    │
│  │     • 触发 webhook: workflow.execute                        │    │
│  └──────────────┬─────────────────────────────────────────────┘    │
│                 │                                                    │
│                 │                                                    │
│  ┌──────────────▼─────────────────────────────────────────────┐    │
│  │  3. 根据 orchestration 类型执行                             │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │                                                             │    │
│  │  IF orchestration === "sequential":                        │    │
│  │  ┌───────────────────────────────────────────────────┐    │    │
│  │  │  FOR EACH step IN steps (按 stepIndex 顺序):      │    │    │
│  │  │                                                    │    │    │
│  │  │  ┌─────────────────────────────────────────┐     │    │    │
│  │  │  │ a. 更新 step.status = "running"         │     │    │    │
│  │  │  │    触发: workflow.step.started           │     │    │    │
│  │  │  └─────────────┬───────────────────────────┘     │    │    │
│  │  │                │                                  │    │    │
│  │  │  ┌─────────────▼───────────────────────────┐     │    │    │
│  │  │  │ b. 准备输入 context                     │     │    │    │
│  │  │  │    {                                     │     │    │    │
│  │  │  │      task: workflow.task,                │     │    │    │
│  │  │  │      description: workflow.description,  │     │    │    │
│  │  │  │      role: step.role,                    │     │    │    │
│  │  │  │      sharedMemory: workflow.sharedMemory,│     │    │    │
│  │  │  │      previousSteps: [...],               │     │    │    │
│  │  │  │      mcpToken: workflow.mcpToken,        │     │    │    │
│  │  │  │      agentAuthority: step.authority      │     │    │    │
│  │  │  │    }                                     │     │    │    │
│  │  │  └─────────────┬───────────────────────────┘     │    │    │
│  │  │                │                                  │    │    │
│  │  │  ┌─────────────▼───────────────────────────┐     │    │    │
│  │  │  │ c. 调用 Agent 端点                      │     │    │    │
│  │  │  │    POST agent.endpoint                  │     │    │    │
│  │  │  │    Authorization: Bearer {mcpToken}     │     │    │    │
│  │  │  │    Body: {input context}                │     │    │    │
│  │  │  │    Timeout: workflow.maxExecutionTime   │     │    │    │
│  │  │  └─────────────┬───────────────────────────┘     │    │    │
│  │  │                │                                  │    │    │
│  │  │  ┌─────────────▼───────────────────────────┐     │    │    │
│  │  │  │ d. 存储 output 到 sharedMemory          │     │    │    │
│  │  │  │    key: `step_${stepIndex}_${agentName}`│     │    │    │
│  │  │  │    value: { output, timestamp, ... }    │     │    │    │
│  │  │  └─────────────┬───────────────────────────┘     │    │    │
│  │  │                │                                  │    │    │
│  │  │  ┌─────────────▼───────────────────────────┐     │    │    │
│  │  │  │ e. 链上记录 (如果 recordOnChain=true)   │     │    │    │
│  │  │  │    调用 ERC-8004 合约                    │     │    │    │
│  │  │  │    recordInteraction(...)                │     │    │    │
│  │  │  └─────────────┬───────────────────────────┘     │    │    │
│  │  │                │                                  │    │    │
│  │  │  ┌─────────────▼───────────────────────────┐     │    │    │
│  │  │  │ f. 更新 step.status = "completed"       │     │    │    │
│  │  │  │    触发: workflow.step.completed         │     │    │    │
│  │  │  └─────────────────────────────────────────┘     │    │    │
│  │  │                                                    │    │    │
│  │  └────────────────────────────────────────────────────┘    │    │
│  │                                                             │    │
│  │                                                             │    │
│  │  IF orchestration === "parallel":                          │    │
│  │  ┌───────────────────────────────────────────────────┐    │    │
│  │  │  Promise.all(steps.map(async step => {            │    │    │
│  │  │    // 同上 a-f 步骤，但所有 agent 并发执行         │    │    │
│  │  │  }))                                               │    │    │
│  │  │                                                    │    │    │
│  │  │  等待所有 steps 完成后:                            │    │    │
│  │  │  ┌─────────────────────────────────────────┐     │    │    │
│  │  │  │ 权威加权共识决策                         │     │    │    │
│  │  │  │                                         │     │    │    │
│  │  │  │ finalDecision = weightedConsensus(     │     │    │    │
│  │  │  │   steps.map(s => ({                    │     │    │    │
│  │  │  │     output: s.output,                  │     │    │    │
│  │  │  │     authority: s.authority || 1.0      │     │    │    │
│  │  │  │   }))                                  │     │    │    │
│  │  │  │ )                                      │     │    │    │
│  │  │  │                                         │     │    │    │
│  │  │  │ 存储到 sharedMemory._consensus          │     │    │    │
│  │  │  └─────────────────────────────────────────┘     │    │    │
│  │  └───────────────────────────────────────────────────┘    │    │
│  │                                                             │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                 │                                                    │
│  ┌──────────────▼─────────────────────────────────────────────┐    │
│  │  4. 更新 workflow.status = "completed"                      │    │
│  │     • 记录 completedAt 时间戳                               │    │
│  │     • 计算 totalExecutionTime                               │    │
│  │     • 触发 webhook: workflow.completed                      │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  错误处理:                                                           │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  IF 任何 step 失败:                                         │    │
│  │    • 更新 step.status = "failed"                            │    │
│  │    • 记录 error 信息                                        │    │
│  │    • 触发 webhook: workflow.step.failed                     │    │
│  │    • (sequential) 中止后续 steps                            │    │
│  │    • 更新 workflow.status = "failed"                        │    │
│  │    • 触发 webhook: workflow.failed                          │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

---

### 4️⃣ MCP (Model Context Protocol) 实现

```
┌──────────────────────────────────────────────────────────────────────┐
│  server/mcp-cloud.ts                                                │
│  核心: 无状态 MCP Server (兼容 PM2 集群)                             │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  端点: POST /api/mcp                                                 │
│                                                                      │
│  认证:                                                               │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  • Authorization: Bearer {mcpToken}                        │    │
│  │  • X-MCP-Token: {mcpToken}  (向后兼容)                     │    │
│  │                                                             │    │
│  │  验证流程:                                                  │    │
│  │  1. 从 header 提取 token                                   │    │
│  │  2. SELECT * FROM MCPToken WHERE token = ?                 │    │
│  │  3. 验证 expiresAt > NOW()                                 │    │
│  │  4. 加载 permissions: ["read", "write", "propose"]         │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  JSON-RPC 2.0 协议:                                                  │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  请求格式:                                                  │    │
│  │  {                                                          │    │
│  │    jsonrpc: "2.0",                                          │    │
│  │    method: "tools/call",                                    │    │
│  │    params: {                                                │    │
│  │      name: "share_reasoning",                               │    │
│  │      arguments: { ... }                                     │    │
│  │    },                                                       │    │
│  │    id: 1                                                    │    │
│  │  }                                                          │    │
│  │                                                             │    │
│  │  响应格式:                                                  │    │
│  │  {                                                          │    │
│  │    jsonrpc: "2.0",                                          │    │
│  │    result: { ... },                                         │    │
│  │    id: 1                                                    │    │
│  │  }                                                          │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  支持的 RPC 方法:                                                    │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  • tools/list        - 列出所有可用工具                     │    │
│  │  • tools/call        - 调用特定工具                         │    │
│  │  • prompts/list      - 列出提示模板                         │    │
│  │  • prompts/get       - 获取提示内容                         │    │
│  │  • resources/list    - 列出资源                             │    │
│  │  • resources/read    - 读取资源内容                         │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘

                                ▼

┌──────────────────────────────────────────────────────────────────────┐
│  10 个协作工具详解                                                    │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  1️⃣ share_reasoning                                                 │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  权限: write                                                │    │
│  │  功能: 分享思考过程和推理逻辑                               │    │
│  │  参数:                                                      │    │
│  │    • reasoning: string (必需)                               │    │
│  │    • category?: "analysis"|"decision"|"observation"         │    │
│  │    • confidence?: number (0.0-1.0)                          │    │
│  │  实现:                                                      │    │
│  │    • 存储到 workflow.sharedMemory._reasoning[]              │    │
│  │    • 包含时间戳、agentId、category                          │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  2️⃣ get_other_agent_context                                         │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  权限: read                                                 │    │
│  │  功能: 获取其他 agent 的最新更新                            │    │
│  │  参数:                                                      │    │
│  │    • agentId?: string (可选，不传则返回所有)                │    │
│  │    • since?: timestamp (可选，增量更新)                     │    │
│  │  返回:                                                      │    │
│  │    • reasoning: [...] 其他 agent 的推理                     │    │
│  │    • decisions: [...] 其他 agent 的决策                     │    │
│  │    • artifacts: [...] 其他 agent 分享的产物                 │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  3️⃣ propose_shared_decision                                         │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  权限: propose                                              │    │
│  │  功能: 提议影响多个 agent 的决策                            │    │
│  │  参数:                                                      │    │
│  │    • decision: string (必需)                                │    │
│  │    • rationale: string (必需)                               │    │
│  │    • impact: string[] (影响的 agent 角色)                   │    │
│  │    • requiresConsensus: boolean                             │    │
│  │  实现:                                                      │    │
│  │    • 存储到 workflow.sharedMemory._proposals[]              │    │
│  │    • 触发 webhook: workflow.propose                         │    │
│  │    • 如果 requiresConsensus=true，等待其他 agent 投票       │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  4️⃣ get_collaboration_history                                       │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  权限: read                                                 │    │
│  │  功能: 获取完整协作历史                                     │    │
│  │  参数:                                                      │    │
│  │    • filter?: "reasoning"|"decisions"|"artifacts"|"all"     │    │
│  │    • limit?: number (默认 100)                              │    │
│  │    • offset?: number (分页)                                 │    │
│  │  返回: 按时间倒序的历史记录                                 │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  5️⃣ sync_progress                                                   │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  权限: write                                                │    │
│  │  功能: 同步已完成任务和后续步骤                             │    │
│  │  参数:                                                      │    │
│  │    • completedTasks: string[]                               │    │
│  │    • nextSteps: string[]                                    │    │
│  │    • blockers?: string[]                                    │    │
│  │  实现:                                                      │    │
│  │    • 更新 workflow.sharedMemory._progress                   │    │
│  │    • 记录时间戳和 agentId                                   │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  6️⃣ ask_question                                                    │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  权限: write                                                │    │
│  │  功能: 向其他 agent 提问                                    │    │
│  │  参数:                                                      │    │
│  │    • question: string (必需)                                │    │
│  │    • targetAgent?: string (特定 agent，或广播)              │    │
│  │    • priority?: "low"|"medium"|"high"                       │    │
│  │  实现:                                                      │    │
│  │    • 存储到 workflow.sharedMemory._questions[]              │    │
│  │    • 生成唯一 questionId                                    │    │
│  │    • 其他 agent 可通过 get_other_agent_context 查看         │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  7️⃣ assign_task                                                     │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  权限: write                                                │    │
│  │  功能: 分配任务给特定 agent 角色                            │    │
│  │  参数:                                                      │    │
│  │    • taskDescription: string (必需)                         │    │
│  │    • assignedTo: string (agent 角色)                        │    │
│  │    • dueBy?: timestamp                                      │    │
│  │    • dependencies?: string[] (依赖的 taskId)                │    │
│  │  实现:                                                      │    │
│  │    • INSERT INTO Task 表                                    │    │
│  │    • status: "pending"                                      │    │
│  │    • 生成唯一 taskId                                        │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  8️⃣ get_tasks                                                       │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  权限: read                                                 │    │
│  │  功能: 获取分配给你或你创建的任务                           │    │
│  │  参数:                                                      │    │
│  │    • filter?: "assigned_to_me"|"created_by_me"|"all"       │    │
│  │    • status?: "pending"|"in_progress"|"completed"           │    │
│  │  返回: 任务列表                                             │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  9️⃣ update_task                                                     │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  权限: write                                                │    │
│  │  功能: 更新任务状态                                         │    │
│  │  参数:                                                      │    │
│  │    • taskId: string (必需)                                  │    │
│  │    • status: "in_progress"|"completed"|"blocked"            │    │
│  │    • result?: string                                        │    │
│  │    • evidence?: object (结果证据)                           │    │
│  │  实现:                                                      │    │
│  │    • UPDATE Task SET ...                                    │    │
│  │    • 记录 completedAt (如果 status=completed)               │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  🔟 share_artifact                                                  │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  权限: write                                                │    │
│  │  功能: 分享代码、日志、测试、配置等产物                     │    │
│  │  参数:                                                      │    │
│  │    • type: "code"|"log"|"test"|"config"|"doc"               │    │
│  │    • content: string (必需)                                 │    │
│  │    • filename?: string                                      │    │
│  │    • description?: string                                   │    │
│  │  实现:                                                      │    │
│  │    • 存储到 workflow.sharedMemory._artifacts[]              │    │
│  │    • 生成唯一 artifactId                                    │    │
│  │    • 包含时间戳、agentId                                    │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 📊 数据库 Schema

```sql
-- ============================================
-- Workflow 表: 工作流配置
-- ============================================
CREATE TABLE "Workflow" (
  id                  TEXT PRIMARY KEY,          -- wf_xxxxx
  task                TEXT NOT NULL,             -- 任务描述
  description         TEXT,                      -- 详细说明
  status              TEXT NOT NULL,             -- pending|running|completed|failed|cancelled
  orchestration       TEXT NOT NULL,             -- sequential|parallel
  memorySharing       BOOLEAN NOT NULL DEFAULT true,
  memoryTTL           INTEGER,                   -- 秒
  maxExecutionTime    INTEGER,                   -- 秒
  recordOnChain       BOOLEAN NOT NULL DEFAULT false,
  sharedMemory        JSON NOT NULL DEFAULT '{}', -- 共享状态
  webhookUrl          TEXT,                      -- Webhook 回调 URL (最长 2048 字符)
  webhookSecret       TEXT,                      -- HMAC 签名密钥
  webhookEvents       JSON,                      -- 订阅的事件类型数组
  startedAt           TIMESTAMP,
  completedAt         TIMESTAMP,
  totalExecutionTime  INTEGER,                   -- 毫秒
  createdBy           INTEGER NOT NULL,          -- User ID
  createdAt           TIMESTAMP DEFAULT NOW(),
  updatedAt           TIMESTAMP DEFAULT NOW(),

  FOREIGN KEY (createdBy) REFERENCES "User"(id) ON DELETE CASCADE
);

CREATE INDEX idx_workflow_status ON "Workflow"(status);
CREATE INDEX idx_workflow_created_by ON "Workflow"(createdBy);


-- ============================================
-- WorkflowStep 表: 单个 Agent 执行步骤
-- ============================================
CREATE TABLE "WorkflowStep" (
  id              SERIAL PRIMARY KEY,
  workflowId      TEXT NOT NULL,
  stepIndex       INTEGER NOT NULL,
  agentId         TEXT NOT NULL,
  agentName       TEXT NOT NULL,
  role            TEXT,
  status          TEXT NOT NULL,              -- pending|running|completed|failed
  input           JSON,                       -- Agent 输入 context
  output          JSON,                       -- Agent 输出结果
  error           TEXT,                       -- 错误信息
  memoryKeys      JSON,                       -- 访问的 memory keys
  startedAt       TIMESTAMP,
  completedAt     TIMESTAMP,
  executionTime   INTEGER,                    -- 毫秒

  FOREIGN KEY (workflowId) REFERENCES "Workflow"(id) ON DELETE CASCADE,
  UNIQUE(workflowId, stepIndex)
);

CREATE INDEX idx_workflow_step_workflow ON "WorkflowStep"(workflowId);
CREATE INDEX idx_workflow_step_status ON "WorkflowStep"(status);


-- ============================================
-- WebhookEvent 表: Webhook 审计日志
-- ============================================
CREATE TABLE "WebhookEvent" (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workflowId      TEXT NOT NULL,
  direction       TEXT NOT NULL,              -- inbound|outbound
  event           TEXT NOT NULL,              -- workflow.created, step.completed, etc.
  action          TEXT,                       -- propose|execute|stop|sync|tool (inbound only)
  requestId       TEXT UNIQUE,                -- 幂等键
  payload         JSON NOT NULL,
  status          TEXT NOT NULL,              -- pending|processing|delivered|failed|dlq
  attempts        INTEGER NOT NULL DEFAULT 0,
  statusCode      INTEGER,
  error           TEXT,
  sourceIp        TEXT,
  createdAt       TIMESTAMP DEFAULT NOW(),
  processedAt     TIMESTAMP,

  FOREIGN KEY (workflowId) REFERENCES "Workflow"(id) ON DELETE CASCADE
);

CREATE INDEX idx_webhook_event_workflow ON "WebhookEvent"(workflowId);
CREATE INDEX idx_webhook_event_status ON "WebhookEvent"(status);
CREATE INDEX idx_webhook_event_request_id ON "WebhookEvent"(requestId);
CREATE INDEX idx_webhook_event_direction ON "WebhookEvent"(direction);


-- ============================================
-- MCPToken 表: MCP 认证令牌
-- ============================================
CREATE TABLE "MCPToken" (
  id              SERIAL PRIMARY KEY,
  token           TEXT UNIQUE NOT NULL,       -- mcp_xxxxx
  userId          INTEGER NOT NULL,
  workflowId      TEXT,                       -- 关联的工作流 (可选)
  permissions     JSON NOT NULL,              -- ["read", "write", "propose"]
  expiresAt       TIMESTAMP,
  lastUsedAt      TIMESTAMP,
  createdAt       TIMESTAMP DEFAULT NOW(),

  FOREIGN KEY (userId) REFERENCES "User"(id) ON DELETE CASCADE,
  FOREIGN KEY (workflowId) REFERENCES "Workflow"(id) ON DELETE SET NULL
);

CREATE INDEX idx_mcp_token_user ON "MCPToken"(userId);
CREATE INDEX idx_mcp_token_workflow ON "MCPToken"(workflowId);
CREATE INDEX idx_mcp_token_token ON "MCPToken"(token);


-- ============================================
-- Agent 表: AI Agent 注册
-- ============================================
CREATE TABLE "Agent" (
  id              TEXT PRIMARY KEY,           -- ai_claude_xxxxx
  name            TEXT NOT NULL,
  description     TEXT,
  model           TEXT NOT NULL,              -- claude-3-5-sonnet-20241022
  endpoint        TEXT,                       -- 自定义 API 端点
  isPublic        BOOLEAN NOT NULL DEFAULT false,
  ownerId         INTEGER NOT NULL,
  createdAt       TIMESTAMP DEFAULT NOW(),

  FOREIGN KEY (ownerId) REFERENCES "User"(id) ON DELETE CASCADE
);

CREATE INDEX idx_agent_owner ON "Agent"(ownerId);
CREATE INDEX idx_agent_public ON "Agent"(isPublic);
```

---

## 🔐 安全机制

### 1. HMAC-SHA256 签名验证

```typescript
// 签名生成 (发送方)
function generateSignature(payload: object, secret: string): string {
  const timestamp = Math.floor(Date.now() / 1000);
  const body = JSON.stringify(payload);
  const signedPayload = `${timestamp}.${body}`;
  const signature = crypto
    .createHmac('sha256', secret)
    .update(signedPayload)
    .digest('hex');
  return `t=${timestamp},v1=${signature}`;
}

// 签名验证 (接收方)
function verifySignature(
  payload: object,
  signatureHeader: string,
  secret: string
): boolean {
  const [tPart, v1Part] = signatureHeader.split(',');
  const timestamp = parseInt(tPart.split('=')[1]);
  const receivedSignature = v1Part.split('=')[1];

  // 1. 时间窗口验证 (5 分钟)
  const now = Math.floor(Date.now() / 1000);
  if (Math.abs(now - timestamp) > 300) {
    throw new Error('Timestamp too old or too far in the future');
  }

  // 2. 重新计算签名
  const body = JSON.stringify(payload);
  const signedPayload = `${timestamp}.${body}`;
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(signedPayload)
    .digest('hex');

  // 3. 常量时间比较 (防止时序攻击)
  return crypto.timingSafeEqual(
    Buffer.from(receivedSignature),
    Buffer.from(expectedSignature)
  );
}
```

### 2. 权限控制矩阵

| MCP Tool | Read 权限 | Write 权限 | Propose 权限 | 说明 |
|----------|-----------|------------|--------------|------|
| `share_reasoning` | ❌ | ✅ | ❌ | 需要写权限 |
| `get_other_agent_context` | ✅ | ✅ | ✅ | 所有权限可读 |
| `propose_shared_decision` | ❌ | ❌ | ✅ | 需要提议权限 |
| `get_collaboration_history` | ✅ | ✅ | ✅ | 所有权限可读 |
| `sync_progress` | ❌ | ✅ | ❌ | 需要写权限 |
| `ask_question` | ❌ | ✅ | ❌ | 需要写权限 |
| `assign_task` | ❌ | ✅ | ❌ | 需要写权限 |
| `get_tasks` | ✅ | ✅ | ✅ | 所有权限可读 |
| `update_task` | ❌ | ✅ | ❌ | 需要写权限 |
| `share_artifact` | ❌ | ✅ | ❌ | 需要写权限 |

### 3. 限流配置

```typescript
// API Gateway 限流
const rateLimiters = {
  webhookInbound: rateLimit({
    windowMs: 60 * 1000,      // 1 分钟
    max: 30,                  // 30 请求
    keyGenerator: (req) => req.ip,
    message: 'Too many webhook requests'
  }),

  collaboration: rateLimit({
    windowMs: 60 * 1000,
    max: 100,                 // 100 请求/分钟
    keyGenerator: (req) => req.userId
  }),

  mcp: rateLimit({
    windowMs: 60 * 1000,
    max: 500,                 // 500 请求/分钟
    keyGenerator: (req) => req.mcpToken
  })
};

// BullMQ Worker 限流
const workerLimiters = {
  webhookInbound: {
    max: 10,                  // 10 作业/秒
    duration: 1000
  },

  webhookOutbound: {
    max: 20,                  // 20 作业/秒
    duration: 1000
  }
};
```

---

## 📈 监控与可观测性

### 关键指标

```sql
-- 1. Webhook 处理延迟
SELECT
  direction,
  AVG(EXTRACT(EPOCH FROM (processedAt - createdAt))) as avg_latency_seconds,
  PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY EXTRACT(EPOCH FROM (processedAt - createdAt))) as p95_latency
FROM "WebhookEvent"
WHERE processedAt IS NOT NULL
  AND createdAt > NOW() - INTERVAL '1 hour'
GROUP BY direction;

-- 2. Webhook 失败率
SELECT
  direction,
  event,
  COUNT(*) as total,
  SUM(CASE WHEN status IN ('failed', 'dlq') THEN 1 ELSE 0 END) as failures,
  ROUND(100.0 * SUM(CASE WHEN status IN ('failed', 'dlq') THEN 1 ELSE 0 END) / COUNT(*), 2) as failure_rate_percent
FROM "WebhookEvent"
WHERE createdAt > NOW() - INTERVAL '24 hours'
GROUP BY direction, event
ORDER BY failure_rate_percent DESC;

-- 3. 工作流执行统计
SELECT
  orchestration,
  status,
  COUNT(*) as count,
  AVG(totalExecutionTime / 1000.0) as avg_execution_seconds,
  MIN(totalExecutionTime / 1000.0) as min_execution_seconds,
  MAX(totalExecutionTime / 1000.0) as max_execution_seconds
FROM "Workflow"
WHERE createdAt > NOW() - INTERVAL '7 days'
GROUP BY orchestration, status;

-- 4. Agent 性能分析
SELECT
  ws.agentName,
  COUNT(*) as total_executions,
  AVG(ws.executionTime / 1000.0) as avg_execution_seconds,
  SUM(CASE WHEN ws.status = 'failed' THEN 1 ELSE 0 END) as failures
FROM "WorkflowStep" ws
WHERE ws.startedAt > NOW() - INTERVAL '7 days'
GROUP BY ws.agentName
ORDER BY total_executions DESC;

-- 5. MCP Token 使用率
SELECT
  DATE_TRUNC('hour', lastUsedAt) as hour,
  COUNT(DISTINCT token) as active_tokens,
  COUNT(*) as total_requests
FROM "MCPToken"
WHERE lastUsedAt > NOW() - INTERVAL '24 hours'
GROUP BY hour
ORDER BY hour DESC;
```

---

## 🚀 部署架构

```
┌───────────────────────────────────────────────────────────────┐
│                     Production Environment                    │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Load Balancer (Nginx)                              │    │
│  │  • SSL Termination                                  │    │
│  │  • Rate Limiting (global)                           │    │
│  │  • Hide duplicate CORS headers                      │    │
│  └────────────┬────────────────────────────────────────┘    │
│               │                                              │
│  ┌────────────▼────────────────────────────────────────┐    │
│  │  PM2 Cluster (4 processes)                          │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐         │    │
│  │  │ Process 1 │ │ Process 2 │ │ Process 3 │ ...     │    │
│  │  │ Express   │ │ Express   │ │ Express   │         │    │
│  │  │ + tRPC    │ │ + tRPC    │ │ + tRPC    │         │    │
│  │  │ + MCP     │ │ + MCP     │ │ + MCP     │         │    │
│  │  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘         │    │
│  └────────┼─────────────┼─────────────┼───────────────┘    │
│           │             │             │                      │
│           └─────────────┴─────────────┘                      │
│                         │                                     │
│  ┌──────────────────────▼─────────────────────────────┐    │
│  │  Redis (Standalone or Cluster)                     │    │
│  │  • BullMQ Queues                                   │    │
│  │  • Session Cache                                   │    │
│  │  • Rate Limit Counters                             │    │
│  └──────────────────────┬─────────────────────────────┘    │
│                         │                                    │
│  ┌──────────────────────▼─────────────────────────────┐    │
│  │  BullMQ Workers (Separate processes)               │    │
│  │  ┌─────────────────────┐ ┌─────────────────────┐  │    │
│  │  │ Inbound Worker      │ │ Outbound Worker     │  │    │
│  │  │ • Concurrency: 3    │ │ • Concurrency: 5    │  │    │
│  │  │ • 10 jobs/s         │ │ • 20 jobs/s         │  │    │
│  │  └─────────────────────┘ └─────────────────────┘  │    │
│  └────────────────────────────────────────────────────┘    │
│                         │                                    │
│  ┌──────────────────────▼─────────────────────────────┐    │
│  │  PostgreSQL (RDS or self-hosted)                   │    │
│  │  • Workflow tables                                 │    │
│  │  • WebhookEvent audit logs                         │    │
│  │  • User/Agent/Token tables                         │    │
│  └────────────────────────────────────────────────────┘    │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Blockchain Node (Avalanche/Polygon)                │  │
│  │  • ERC-8004 Registry Contract                       │  │
│  │  • On-chain reputation recording                    │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

---

## 🔗 集成示例

### 外部系统调用 Webhook 示例

```typescript
// 外部系统: 触发工作流执行
const workflowId = "wf_xxxxx";
const secret = "whsec_xxxxx";
const payload = {
  action: "execute",
  workflowId: workflowId,
  requestId: `req_${Date.now()}_${Math.random()}`, // 幂等键
  metadata: {
    triggeredBy: "external-system",
    reason: "scheduled-task"
  }
};

// 生成签名
const timestamp = Math.floor(Date.now() / 1000);
const body = JSON.stringify(payload);
const signedPayload = `${timestamp}.${body}`;
const signature = crypto
  .createHmac('sha256', secret)
  .update(signedPayload)
  .digest('hex');
const signatureHeader = `t=${timestamp},v1=${signature}`;

// 发送请求
const response = await fetch('https://awareness-market.com/api/webhooks/inbound', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Webhook-Signature': signatureHeader
  },
  body: body
});

const result = await response.json();
console.log('Job ID:', result.jobId); // { success: true, jobId: "job_xxx" }
```

### Agent 使用 MCP Tools 示例

```typescript
// Agent: 分享推理过程
const mcpToken = "mcp_xxxxx";

const response = await fetch('https://awareness-market.com/api/mcp', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${mcpToken}`
  },
  body: JSON.stringify({
    jsonrpc: "2.0",
    method: "tools/call",
    params: {
      name: "share_reasoning",
      arguments: {
        reasoning: "Based on the analysis of user behavior data, I recommend implementing a caching layer to reduce database load by 40%.",
        category: "recommendation",
        confidence: 0.85
      }
    },
    id: 1
  })
});

const result = await response.json();
console.log('Result:', result.result);
// {
//   success: true,
//   reasoningId: "rsn_xxxxx",
//   timestamp: "2026-02-26T12:34:56Z"
// }
```

---

## 📚 相关文档链接

- **部署指南**: [WEBHOOK_ADAPTER_DEPLOY.md](Awareness-Market - MAIN/WEBHOOK_ADAPTER_DEPLOY.md)
- **MCP 工具总结**: [WEBMCP_COMPLETE_SUMMARY.md](Awareness-Market - MAIN/WEBMCP_COMPLETE_SUMMARY.md)
- **MCP 用户指南**: [WEBMCP_USER_GUIDE.md](Awareness-Market - MAIN/WEBMCP_USER_GUIDE.md)
- **数据库 Schema**: [prisma/schema.prisma](Awareness-Market - MAIN/prisma/schema.prisma)
- **配置模板**: [.env.example](Awareness-Market - MAIN/.env.example)

---

## 📝 总结

这个架构展示了一个**企业级多 Agent 协作系统**，具有以下特点:

✅ **异步解耦**: Webhook 通过 BullMQ 实现完全异步处理
✅ **安全可靠**: HMAC-SHA256 签名、时间窗口验证、幂等性保证
✅ **高性能**: PM2 集群、Redis 队列、并发控制
✅ **可扩展**: 无状态 MCP server、模块化设计
✅ **可观测**: 完整审计日志、性能指标、错误追踪
✅ **灵活编排**: 支持顺序/并行执行、权威加权共识
✅ **区块链集成**: ERC-8004 链上信誉记录

---

*最后更新: 2026-02-26*
*架构版本: v2.0*
