# Stripe ç”Ÿäº§ç¯å¢ƒ - å¿«é€Ÿå¯åŠ¨æŒ‡å—

## âœ… å·²å®Œæˆçš„é…ç½®

ä»¥ä¸‹é…ç½®å·²ç»å°±ç»ªï¼š

- âœ… Stripe ç”Ÿäº§ç¯å¢ƒ API å¯†é’¥å·²é…ç½®
- âœ… Webhook ç­¾åå¯†é’¥å·²é…ç½®ï¼ˆ`whsec_5wy2DJA6EqXoo7vcXKqwSWkUBJSkb9m9`ï¼‰
- âœ… Webhook ç«¯ç‚¹å·²åœ¨ Stripe Dashboard åˆ›å»º
- âœ… æœåŠ¡å™¨ä»£ç å·²å®ç°æ‰€æœ‰å¿…éœ€åŠŸèƒ½

## ğŸš€ ç«‹å³å¼€å§‹ï¼ˆ3ä¸ªæ­¥éª¤ï¼‰

### ç¬¬ 1 æ­¥ï¼šå¯åŠ¨æœåŠ¡å™¨

æ‰“å¼€ç»ˆç«¯ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
cd "e:\Awareness Market\Awareness-Network"

# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰
pnpm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm run dev
```

**æˆ–è€…**ï¼Œå¦‚æœè¦ä»¥ç”Ÿäº§æ¨¡å¼è¿è¡Œï¼š

```bash
# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
pnpm run build

# å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨
NODE_ENV=production pnpm start
```

ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨å®Œæˆï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
```
Server running on http://localhost:3001
âœ“ Database connected
âœ“ Stripe initialized
```

### ç¬¬ 2 æ­¥ï¼šæµ‹è¯•é…ç½®

åœ¨**æ–°çš„ç»ˆç«¯çª—å£**ä¸­è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
cd "e:\Awareness Market\Awareness-Network"
npx tsx scripts/test-stripe-webhook.ts
```

è¿™å°†éªŒè¯ï¼š
- âœ… æ‰€æœ‰ç¯å¢ƒå˜é‡éƒ½å·²æ­£ç¡®é…ç½®
- âœ… Webhook ç«¯ç‚¹å¯ä»¥è®¿é—®
- âœ… æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ

### ç¬¬ 3 æ­¥ï¼šåœ¨ Stripe Dashboard æµ‹è¯•

1. **è®¿é—® Stripe Dashboard**ï¼š
   https://dashboard.stripe.com/webhooks

2. **æ‰¾åˆ°æ‚¨çš„ webhook ç«¯ç‚¹**ï¼š
   - URLï¼š`http://44.220.181.78:3001/api/stripe/webhook`

3. **å‘é€æµ‹è¯•äº‹ä»¶**ï¼š
   - ç‚¹å‡» webhook ç«¯ç‚¹
   - ç‚¹å‡» **"å‘é€æµ‹è¯• webhook"**
   - é€‰æ‹©ï¼š`checkout.session.completed`
   - ç‚¹å‡» **"å‘é€æµ‹è¯•äº‹ä»¶"**

4. **éªŒè¯ç»“æœ**ï¼š
   - âœ… çŠ¶æ€åº”è¯¥æ˜¾ç¤º **200 OK**ï¼ˆç»¿è‰²å‹¾å·ï¼‰
   - âœ… åœ¨æœåŠ¡å™¨ç»ˆç«¯ä¸­åº”è¯¥çœ‹åˆ°æ—¥å¿—ï¼š
     ```
     [Stripe:Webhook] Webhook event received eventType=checkout.session.completed
     ```

## ğŸ¯ ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆçœŸå®æ”¯ä»˜æµç¨‹ï¼‰

å®Œæˆä¸Šè¿°æ­¥éª¤åï¼Œè¿›è¡Œå®Œæ•´çš„æ”¯ä»˜æµç¨‹æµ‹è¯•ï¼š

### 1. è®¿é—®æ‚¨çš„ç½‘ç«™

æ‰“å¼€æµè§ˆå™¨ï¼š`http://44.220.181.78:3001`

### 2. åˆ›å»ºè´¦æˆ·å¹¶ç™»å½•

å¦‚æœè¿˜æ²¡æœ‰è´¦æˆ·ï¼Œæ³¨å†Œä¸€ä¸ªæ–°è´¦æˆ·ã€‚

### 3. åˆ›å»ºç»„ç»‡

1. ç‚¹å‡» **"åˆ›å»ºç»„ç»‡"** æˆ– **"Organization Setup"**
2. è¾“å…¥ç»„ç»‡åç§°ï¼ˆå¦‚ï¼š`Test Company`ï¼‰
3. é€‰æ‹© **Lite** æˆ– **Team** è®¡åˆ’ï¼ˆæ¨èä»ä½ä»·è®¡åˆ’å¼€å§‹æµ‹è¯•ï¼‰

### 4. å‡çº§åˆ°ä»˜è´¹è®¡åˆ’

1. åœ¨ç»„ç»‡é¡µé¢ï¼Œç‚¹å‡» **"å‡çº§"** æˆ– **"Upgrade"**
2. é€‰æ‹©è®¡åˆ’ï¼š
   - **Lite**: $49/æœˆï¼ˆ8 agentsï¼‰
   - **Team**: $199/æœˆï¼ˆ32 agentsï¼‰
   - **Enterprise**: $499/æœˆï¼ˆ128 agentsï¼‰
   - **Scientific**: $999/æœˆï¼ˆUnlimited agentsï¼‰

### 5. ä½¿ç”¨æµ‹è¯•å¡å®Œæˆæ”¯ä»˜

åœ¨ Stripe Checkout é¡µé¢è¾“å…¥ï¼š

**æµ‹è¯•å¡ä¿¡æ¯**ï¼ˆå³ä½¿åœ¨ç”Ÿäº§ç¯å¢ƒä¹Ÿä¸ä¼šäº§ç”ŸçœŸå®è´¹ç”¨ï¼‰ï¼š
- **å¡å·**ï¼š`4242 4242 4242 4242`
- **æœ‰æ•ˆæœŸ**ï¼šä»»æ„æœªæ¥æ—¥æœŸï¼ˆå¦‚ `12/34`ï¼‰
- **CVC**ï¼šä»»æ„ 3 ä½æ•°å­—ï¼ˆå¦‚ `123`ï¼‰
- **é‚®ç¼–**ï¼šä»»æ„ 5 ä½ï¼ˆå¦‚ `12345`ï¼‰
- **å§“å**ï¼šä»»æ„åå­—

ç‚¹å‡» **"è®¢é˜…"** æˆ– **"Subscribe"**ã€‚

### 6. éªŒè¯ç»“æœ

æ”¯ä»˜æˆåŠŸåï¼š

#### 6.1 æ£€æŸ¥ç½‘ç«™
- âœ… åº”è¯¥é‡å®šå‘å›æ‚¨çš„ç½‘ç«™
- âœ… çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
- âœ… ç»„ç»‡çš„ Plan Tier å·²æ›´æ–°

#### 6.2 æ£€æŸ¥ Stripe Dashboard
è®¿é—®ï¼šhttps://dashboard.stripe.com/payments
- âœ… çœ‹åˆ°æ–°çš„æ”¯ä»˜è®°å½•
- âœ… é‡‘é¢æ­£ç¡®ï¼ˆ$49 / $199 / $499 / $999ï¼‰
- âœ… çŠ¶æ€ä¸º "Succeeded"

#### 6.3 æ£€æŸ¥ Webhook æ—¥å¿—
åœ¨ Stripe Dashboard â†’ Webhooks â†’ æ‚¨çš„ç«¯ç‚¹ï¼š
- âœ… çœ‹åˆ° `checkout.session.completed` äº‹ä»¶
- âœ… çŠ¶æ€ä¸º 200 OK

#### 6.4 æ£€æŸ¥æ•°æ®åº“
è¿æ¥æ•°æ®åº“å¹¶æŸ¥è¯¢ï¼š

```sql
SELECT id, name, "planTier", "maxAgents", "stripeCustomerId"
FROM "Organization"
ORDER BY "updatedAt" DESC
LIMIT 1;
```

åº”è¯¥çœ‹åˆ°ï¼š
- âœ… `planTier` å·²æ›´æ–°ä¸ºæ‚¨é€‰æ‹©çš„è®¡åˆ’ï¼ˆ`lite`/`team`/`enterprise`/`scientific`ï¼‰
- âœ… `stripeCustomerId` å·²å¡«å……ï¼ˆä»¥ `cus_` å¼€å¤´ï¼‰

## ğŸ“Š ç›‘æ§è¿è¡ŒçŠ¶æ€

### æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

åœ¨æœåŠ¡å™¨ç»ˆç«¯ä¸­ï¼Œæ‚¨ä¼šçœ‹åˆ°ï¼š

**æˆåŠŸçš„ webhook äº‹ä»¶**ï¼š
```
[Stripe:Webhook] Webhook event received eventType=checkout.session.completed eventId=evt_xxx
[Stripe:Webhook] Organization plan upgraded orgId=1 userId=1 targetTier=lite customerId=cus_xxx
```

**æ”¯ä»˜å¤„ç†**ï¼š
```
[OrgService] Organization upgraded organizationId=1 newTier=lite
```

### æŸ¥çœ‹ Stripe Dashboard

å®šæœŸæ£€æŸ¥ï¼š
- **Payments**ï¼šhttps://dashboard.stripe.com/payments
- **Subscriptions**ï¼šhttps://dashboard.stripe.com/subscriptions
- **Customers**ï¼šhttps://dashboard.stripe.com/customers
- **Webhooks**ï¼šhttps://dashboard.stripe.com/webhooks

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: Webhook è¿”å› 401 æˆ– 400 é”™è¯¯ï¼Ÿ

**åŸå› **ï¼šç­¾åéªŒè¯å¤±è´¥

**è§£å†³**ï¼š
1. æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `STRIPE_WEBHOOK_SECRET`
2. ç¡®ä¿æ²¡æœ‰å¤šä½™çš„ç©ºæ ¼æˆ–æ¢è¡Œç¬¦
3. é‡å¯æœåŠ¡å™¨
4. åœ¨ Stripe Dashboard é‡æ–°ç”Ÿæˆç­¾åå¯†é’¥

### Q2: æœåŠ¡å™¨å¯åŠ¨å¤±è´¥ï¼Ÿ

**æ£€æŸ¥**ï¼š
```bash
# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -ano | findstr :3001

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
# ç¡®ä¿ DATABASE_URL æ­£ç¡®

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
pnpm run dev
```

### Q3: æ”¯ä»˜æˆåŠŸä½†æ•°æ®åº“æœªæ›´æ–°ï¼Ÿ

**è°ƒè¯•æ­¥éª¤**ï¼š
1. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼Œç¡®è®¤æ”¶åˆ° webhook
2. æ£€æŸ¥ webhook payload ä¸­çš„ metadata
3. åœ¨ Stripe Dashboard æ‰‹åŠ¨é‡æ”¾ï¼ˆResendï¼‰webhook
4. æ£€æŸ¥æ•°æ®åº“è¿æ¥å’Œæƒé™

### Q4: æ— æ³•è®¿é—® http://44.220.181.78:3001ï¼Ÿ

**è§£å†³**ï¼š
1. ç¡®è®¤æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
2. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™ï¼ˆå…è®¸ç«¯å£ 3001ï¼‰
3. å¦‚æœæ˜¯æœ¬åœ°å¼€å‘ï¼Œä½¿ç”¨ `http://localhost:3001`
4. è€ƒè™‘ä½¿ç”¨åŸŸåå¹¶é…ç½® HTTPS

## ğŸ” å®‰å…¨æ£€æŸ¥æ¸…å•

åœ¨æ¥æ”¶çœŸå®å®¢æˆ·ä»˜æ¬¾å‰ï¼š

- [ ] ç¡®è®¤ä½¿ç”¨çš„æ˜¯ç”Ÿäº§å¯†é’¥ï¼ˆ`sk_live_`ï¼Œä¸æ˜¯ `sk_test_`ï¼‰
- [ ] Webhook ç­¾åéªŒè¯å·²å¯ç”¨ï¼ˆä»£ç ä¸­å·²å®ç°ï¼‰
- [ ] `.env` æ–‡ä»¶æœªæäº¤åˆ° Gitï¼ˆæ£€æŸ¥ `.gitignore`ï¼‰
- [ ] é˜²ç«å¢™å·²é…ç½®ï¼ˆä»…å…è®¸å¿…è¦çš„ç«¯å£ï¼‰
- [ ] è€ƒè™‘è¿ç§»åˆ° HTTPSï¼ˆç”Ÿäº§ç¯å¢ƒå¼ºçƒˆæ¨èï¼‰
- [ ] å·²å®Œæˆ Stripe è´¦æˆ·éªŒè¯ï¼ˆä¼ä¸šä¿¡æ¯ã€é“¶è¡Œè´¦æˆ·ï¼‰
- [ ] å·²è®¾ç½® Stripe å¤±è´¥ webhook å‘Šè­¦

## ğŸ’° æ”¶æ¬¾ç¡®è®¤

é…ç½®å®Œæˆå¹¶æµ‹è¯•é€šè¿‡åï¼š

### ä»˜æ¬¾æµå‘
```
å®¢æˆ·é€‰æ‹©è®¡åˆ’ â†’ Stripe å¤„ç†ä»˜æ¬¾ â†’ èµ„é‡‘è¿›å…¥æ‚¨çš„ Stripe è´¦æˆ·
     â†“                                         â†“
  æ‰£é™¤æ‰‹ç»­è´¹                              T+2 å¤©å¯æç°åˆ°é“¶è¡Œ
 (2.9% + $0.30)                               â†“
                                        æŸ¥çœ‹ä½™é¢å’Œæç°
                               https://dashboard.stripe.com/balance
```

### æ‰‹ç»­è´¹ç¤ºä¾‹

| è®¡åˆ’ | æœˆè´¹ | Stripe æ‰‹ç»­è´¹ | æ‚¨çš„å‡€æ”¶å…¥ |
|------|------|---------------|-----------|
| Lite | $49 | $1.72 | $47.28 |
| Team | $199 | $6.07 | $192.93 |
| Enterprise | $499 | $14.77 | $484.23 |
| Scientific | $999 | $29.27 | $969.73 |

### æç°åˆ°é“¶è¡Œ

1. è®¿é—®ï¼šhttps://dashboard.stripe.com/settings/payouts
2. ç¡®è®¤é“¶è¡Œè´¦æˆ·å·²ç»‘å®š
3. è®¾ç½®æç°è®¡åˆ’ï¼š
   - **æ ‡å‡†**ï¼šT+2 å¤©è‡ªåŠ¨æç°ï¼ˆå…è´¹ï¼‰
   - **å³æ—¶**ï¼šç«‹å³æç°ï¼ˆéœ€é¢å¤–è´¹ç”¨ï¼‰

## ğŸ‰ æ­å–œï¼ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œæ‚¨çš„ç³»ç»Ÿå·²ç»ï¼š

- âœ… å¯ä»¥æ¥æ”¶çœŸå®å®¢æˆ·ä»˜æ¬¾
- âœ… è‡ªåŠ¨å¤„ç†è®¢é˜…å‡çº§/é™çº§
- âœ… è‡ªåŠ¨æ›´æ–°ç»„ç»‡è®¡åˆ’ç­‰çº§
- âœ… å‘é€ç¡®è®¤é‚®ä»¶ç»™å®¢æˆ·
- âœ… è¿½è¸ªæ‰€æœ‰æ”¯ä»˜äº‹ä»¶

**ç°åœ¨å¯ä»¥å¼€å§‹è¥é”€æ¨å¹¿æ‚¨çš„ AI Organization Governance æœåŠ¡äº†ï¼** ğŸš€

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

- **è¯¦ç»†é…ç½®æŒ‡å—**ï¼š[STRIPE_WEBHOOK_SETUP.md](STRIPE_WEBHOOK_SETUP.md)
- **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**ï¼š[STRIPE_PRODUCTION_SETUP.md](STRIPE_PRODUCTION_SETUP.md)
- **Stripe æ–‡æ¡£**ï¼šhttps://stripe.com/docs
- **Stripe Dashboard**ï¼šhttps://dashboard.stripe.com

---

**ä¸‹ä¸€æ­¥**ï¼šå¯åŠ¨æœåŠ¡å™¨å¹¶è¿è¡Œæµ‹è¯•è„šæœ¬ â†’ [ç¬¬ 1 æ­¥](#ç¬¬-1-æ­¥å¯åŠ¨æœåŠ¡å™¨)
