name: Setup HTTPS (Nginx + Let's Encrypt)

on:
  workflow_dispatch:
    inputs:
      force_renew:
        description: 'Force certificate renewal even if not expired'
        type: boolean
        default: false

jobs:
  setup-https:
    name: Configure Nginx + SSL on EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.AWARENESS }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/awareness-key.pem
          chmod 600 ~/.ssh/awareness-key.pem
          ssh-keyscan -H 44.220.181.78 >> ~/.ssh/known_hosts

      - name: Upload Nginx config to EC2
        run: |
          ssh -i ~/.ssh/awareness-key.pem ec2-user@44.220.181.78 \
            "mkdir -p /home/ec2-user/Awareness-Market/nginx"
          scp -i ~/.ssh/awareness-key.pem \
            nginx/awareness.market.conf \
            ec2-user@44.220.181.78:/home/ec2-user/Awareness-Market/nginx/

      - name: Upload setup script
        run: |
          scp -i ~/.ssh/awareness-key.pem \
            scripts/setup-https.sh \
            ec2-user@44.220.181.78:/tmp/setup-https.sh

      - name: Run HTTPS setup on EC2
        run: |
          ssh -i ~/.ssh/awareness-key.pem ec2-user@44.220.181.78 << 'ENDSSH'
            chmod +x /tmp/setup-https.sh
            bash /tmp/setup-https.sh
            rm -f /tmp/setup-https.sh
          ENDSSH

      - name: Update production .env on EC2
        run: |
          ssh -i ~/.ssh/awareness-key.pem ec2-user@44.220.181.78 << 'ENDSSH'
            ENV_FILE="/home/ec2-user/Awareness-Market/.env"
            if [ -f "$ENV_FILE" ]; then
              sed -i 's|^BASE_URL=.*|BASE_URL=https://api.awareness.market|' "$ENV_FILE"
              sed -i 's|^OAUTH_SERVER_URL=.*|OAUTH_SERVER_URL=https://api.awareness.market|' "$ENV_FILE"
              sed -i 's|^OAUTH_CALLBACK_URL=.*|OAUTH_CALLBACK_URL=https://api.awareness.market|' "$ENV_FILE"
              echo ".env updated:"
              grep -E "^(BASE_URL|OAUTH_SERVER_URL|OAUTH_CALLBACK_URL)" "$ENV_FILE"
              pm2 restart awareness-network || pm2 restart all || true
            else
              echo "WARNING: $ENV_FILE not found"
            fi
          ENDSSH

      - name: Verify HTTPS
        run: |
          echo "Waiting for Nginx to reload..."
          sleep 5
          echo "Testing https://api.awareness.market ..."
          curl -f --max-time 15 https://api.awareness.market/api-docs/ \
            || echo "Warning: HTTPS check failed (DNS may still be propagating)"

      - name: Show certificate info
        run: |
          ssh -i ~/.ssh/awareness-key.pem ec2-user@44.220.181.78 \
            "sudo certbot certificates 2>/dev/null || echo 'certbot not available'"

      - name: Summary
        run: |
          echo "======================================"
          echo "  HTTPS setup complete!"
          echo "  API: https://api.awareness.market"
          echo "======================================"
          echo ""
          echo "Next steps:"
          echo "  1. Vercel: set VITE_API_URL=https://api.awareness.market"
          echo "  2. Stripe: update webhook to https://api.awareness.market/api/stripe/webhook"
          echo "  3. GitHub OAuth: https://api.awareness.market/api/auth/github/callback"
          echo "  4. Google OAuth: https://api.awareness.market/api/auth/google/callback"
