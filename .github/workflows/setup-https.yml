name: Setup HTTPS (Nginx + Let's Encrypt)

on:
  workflow_dispatch:
    inputs:
      force_renew:
        description: 'Force certificate renewal even if not expired'
        type: boolean
        default: false

jobs:
  setup-https:
    name: Configure Nginx + SSL on EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.AWARENESS }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/awareness-key.pem
          chmod 600 ~/.ssh/awareness-key.pem
          ssh-keyscan -H 44.220.181.78 >> ~/.ssh/known_hosts

      - name: Upload Nginx config to EC2
        run: |
          ssh -i ~/.ssh/awareness-key.pem ec2-user@44.220.181.78 \
            "mkdir -p /home/ec2-user/Awareness-Market/nginx"
          scp -i ~/.ssh/awareness-key.pem \
            nginx/awareness.market.conf \
            ec2-user@44.220.181.78:/home/ec2-user/Awareness-Market/nginx/

      - name: Upload setup script
        run: |
          scp -i ~/.ssh/awareness-key.pem \
            scripts/setup-https.sh \
            ec2-user@44.220.181.78:/tmp/setup-https.sh

      - name: Run HTTPS setup on EC2
        run: |
          ssh -i ~/.ssh/awareness-key.pem ec2-user@44.220.181.78 << 'ENDSSH'
            chmod +x /tmp/setup-https.sh
            bash /tmp/setup-https.sh
            rm -f /tmp/setup-https.sh
          ENDSSH

      - name: Update production BASE_URL to HTTPS on EC2
        run: |
          ssh -i ~/.ssh/awareness-key.pem ec2-user@44.220.181.78 << 'ENDSSH'
            ENV_FILE="/home/ec2-user/Awareness-Market/.env"
            if [ -f "$ENV_FILE" ]; then
              # Update BASE_URL to HTTPS
              sed -i 's|^BASE_URL=.*|BASE_URL=https://awareness.market|' "$ENV_FILE"
              # Update OAUTH URLs
              sed -i 's|^OAUTH_SERVER_URL=.*|OAUTH_SERVER_URL=https://awareness.market|' "$ENV_FILE"
              sed -i 's|^OAUTH_CALLBACK_URL=.*|OAUTH_CALLBACK_URL=https://awareness.market|' "$ENV_FILE"
              echo "  .env updated with HTTPS URLs."
              grep -E "^(BASE_URL|OAUTH_SERVER_URL|OAUTH_CALLBACK_URL)" "$ENV_FILE"
              # Restart PM2 so env changes take effect
              pm2 restart awareness-market-api || true
            else
              echo "  WARNING: $ENV_FILE not found — update BASE_URL manually"
            fi
          ENDSSH

      - name: Verify HTTPS is working
        run: |
          sleep 5
          echo "Testing HTTPS endpoint..."
          curl -f --max-time 15 https://awareness.market/api-docs/ \
            -H "Host: awareness.market" \
            || echo "Warning: HTTPS check failed (DNS may not be propagated yet)"

      - name: Show certificate info
        run: |
          ssh -i ~/.ssh/awareness-key.pem ec2-user@44.220.181.78 \
            "sudo certbot certificates 2>/dev/null || echo 'certbot not yet installed'"

      - name: Success
        run: |
          echo "✅ HTTPS setup complete!"
          echo "   Site: https://awareness.market"
          echo ""
          echo "Remaining manual steps:"
          echo "  1. Update Stripe webhook: https://awareness.market/api/stripe/webhook"
          echo "  2. Update GitHub OAuth callback: https://awareness.market/api/auth/github/callback"
          echo "  3. Update Google OAuth callback: https://awareness.market/api/auth/google/callback"
