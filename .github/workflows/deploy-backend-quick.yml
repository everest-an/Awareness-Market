name: Quick Deploy Backend to EC2

# å¿«é€Ÿéƒ¨ç½²å·¥ä½œæµ - è·³è¿‡æµ‹è¯•ï¼Œç›´æŽ¥éƒ¨ç½²
# é€‚ç”¨åœºæ™¯ï¼šç´§æ€¥ä¿®å¤ã€é…ç½®æ›´æ”¹ã€å°åž‹æ›´æ–°

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  deploy:
    name: Quick Deploy
    runs-on: ubuntu-latest
    environment:
      name: production-backend
      url: http://44.220.181.78:3001/api-docs/

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm exec prisma generate

      - name: Type check (if not skipping tests)
        if: inputs.skip_tests == 'false'
        run: pnpm exec tsc --noEmit || echo "Type check completed with warnings"
        continue-on-error: true

      - name: Configure SSH
        env:
          EC2_SSH_KEY: ${{ secrets.AWARENESS }}
        run: |
          mkdir -p ~/.ssh
          echo "$EC2_SSH_KEY" > ~/.ssh/awareness-key.pem
          chmod 600 ~/.ssh/awareness-key.pem
          ssh-keyscan -H 44.220.181.78 >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          echo "ðŸš€ Starting quick deployment..."

          # Upload files
          rsync -avz -e "ssh -i ~/.ssh/awareness-key.pem" \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'dist/public' \
            --exclude 'client/dist' \
            --exclude '.env' \
            server/ prisma/ package.json pnpm-lock.yaml \
            ec2-user@44.220.181.78:/home/ec2-user/Awareness-Market/

          # Restart service
          ssh -i ~/.ssh/awareness-key.pem ec2-user@44.220.181.78 << 'ENDSSH'
            cd /home/ec2-user/Awareness-Market
            pnpm install --prod --frozen-lockfile
            pnpm exec prisma generate
            pm2 restart awareness-network || pm2 start server/_core/index.ts --name awareness-network
            pm2 status
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 10
          if curl -f http://44.220.181.78:3001/api-docs/; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment verification failed"
            exit 1
          fi

      - name: Show deployment info
        run: |
          echo "## âœ… Deployment Complete"
          echo ""
          echo "ðŸ”— API URL: http://44.220.181.78:3001/api-docs/"
          echo "â° Deployed at: $(date)"
          echo "ðŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
