name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'server/**'
      - 'client/**'
      - 'docs-content/**'
      - 'scripts/copy-docs.ts'
      - 'prisma/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  EC2_HOST: 13.212.149.168
  EC2_USER: ubuntu
  EC2_PATH: /home/ubuntu/awareness-market

jobs:
  deploy:
    name: Build and Deploy Backend
    runs-on: ubuntu-latest
    environment:
      name: production-backend
      url: https://api.awareness.market/api-docs/

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm exec prisma generate

      - name: Build backend
        run: |
          pnpm exec esbuild ./server/_core/index.ts \
            --bundle \
            --platform=node \
            --target=node20 \
            --format=esm \
            --packages=external \
            --outfile=dist/index.js

      - name: Build frontend
        run: |
          pnpm run copy:docs
          pnpm run build:client
        env:
          VITE_API_URL: ${{ vars.VITE_API_URL || 'https://api.awareness.market' }}

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.AWARENESS }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/awareness-key.pem
          chmod 600 ~/.ssh/awareness-key.pem
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Upload files to EC2
        run: |
          SSH_CMD="ssh -i ~/.ssh/awareness-key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }}"
          SCP_CMD="scp -i ~/.ssh/awareness-key.pem"

          $SSH_CMD "mkdir -p ${{ env.EC2_PATH }}/dist"
          $SCP_CMD dist/index.js ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.EC2_PATH }}/dist/
          $SCP_CMD -r dist/public ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.EC2_PATH }}/dist/
          $SCP_CMD package.json ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.EC2_PATH }}/
          $SCP_CMD pnpm-lock.yaml ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.EC2_PATH }}/
          $SCP_CMD -r prisma ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.EC2_PATH }}/
          $SCP_CMD ecosystem.config.cjs ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.EC2_PATH }}/

      - name: Run database migrations and restart
        run: |
          ssh -i ~/.ssh/awareness-key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'ENDSSH'
            cd ${{ env.EC2_PATH }}
            echo "=== Installing dependencies ==="
            pnpm install --frozen-lockfile
            echo "=== Generating Prisma client ==="
            pnpm exec prisma generate
            echo "=== Running migrations ==="
            pnpm exec prisma migrate deploy || echo "Migration skipped (no pending)"
            echo "=== Restarting PM2 ==="
            pm2 restart ecosystem.config.cjs || pm2 start ecosystem.config.cjs
            pm2 status
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 10
          curl -f "https://api.awareness.market/api-docs/" || exit 1

      - name: Collect diagnostics on failure
        if: failure()
        run: |
          ssh -i ~/.ssh/awareness-key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'ENDSSH'
            set +e
            cd ${{ env.EC2_PATH }}
            echo "=== PM2 Status ==="
            pm2 status
            echo "=== Local backend check (127.0.0.1:3001) ==="
            curl -i --max-time 10 http://127.0.0.1:3001/api-docs/ || true
            echo "=== PM2 recent logs ==="
            pm2 logs awareness-market-api --lines 120 --nostream || true
            echo "=== Nginx error log tail ==="
            sudo tail -n 60 /var/log/nginx/error.log || true
          ENDSSH

      - name: Notify result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "Backend deployment successful!"
            echo "API: https://api.awareness.market/api-docs/"
          else
            echo "Backend deployment failed! Check logs above."
          fi
